<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roll-A-Shield Screen Quote Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0056A3 0%, #003D7A 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .content {
            padding: 20px;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .form-section h2 {
            color: #0056A3;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #0056A3;
            padding-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .dimension-group {
            display: flex;
            flex-direction: column;
            min-width: 280px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.85rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0056A3;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group small {
            font-size: 0.75rem;
            margin-top: 2px;
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .accessories-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .accessory-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .accessory-item:hover {
            border-color: #0056A3;
            box-shadow: 0 1px 4px rgba(0, 86, 163, 0.15);
        }

        .accessory-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .accessory-item label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0056A3 0%, #003D7A 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 86, 163, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .quote-summary {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e9f2 100%);
            border-radius: 6px;
            border-left: 4px solid #0056A3;
        }

        .quote-summary h3 {
            color: #0056A3;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #b8d4e3;
            font-size: 0.9rem;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row.total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0056A3;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 2px solid #0056A3;
        }

        .internal-info {
            margin-top: 12px;
            padding: 12px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 4px;
        }

        .internal-info h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .info-text {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
            }

            .button-group,
            .internal-info,
            .header,
            .form-section,
            .saved-quotes,
            #screensInOrder {
                display: none !important;
            }

            #quoteSummary {
                display: block !important;
                margin: 0;
                padding: 20px;
            }
        }

        .alert {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .saved-quotes {
            margin-top: 20px;
        }

        .saved-quotes h3 {
            color: #0056A3;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .quote-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quote-card:hover {
            border-color: #0056A3;
            box-shadow: 0 2px 8px rgba(0, 86, 163, 0.15);
        }

        .quote-card h4 {
            color: #0056A3;
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .quote-card p {
            color: #666;
            font-size: 0.8rem;
            margin: 3px 0;
        }

        .quote-card-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .quote-card-actions button {
            padding: 6px 14px;
            font-size: 0.75rem;
        }

        .screen-card {
            background: white;
            border: 2px solid #0056A3;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .screen-card.editing {
            border-color: #28a745;
            background: #f0fff4;
        }

        .screen-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .screen-card-header h4 {
            color: #0056A3;
            font-size: 1rem;
            margin: 0;
        }

        .screen-card-actions {
            display: flex;
            gap: 8px;
        }

        .screen-card-actions button {
            padding: 5px 12px;
            font-size: 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #007bff;
            color: white;
        }

        .btn-edit:hover {
            background: #0056b3;
        }

        .btn-duplicate {
            background: #28a745;
            color: white;
        }

        .btn-duplicate:hover {
            background: #218838;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .screen-card-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.6;
        }

        .screen-card-details strong {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Roll-A-Shield Screen Quote Tool</h1>
            <p>Custom Rolling Screen Pricing Calculator</p>
        </div>

        <div class="content">
            <!-- Customer Information -->
            <div class="form-section">
                <h2>Customer Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Email</label>
                        <input type="email" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone</label>
                        <input type="tel" id="customerPhone">
                    </div>
                </div>

                <!-- Toggle button for optional fields -->
                <button type="button" id="toggleOptionalFields" style="background: none; border: none; color: #0056A3; cursor: pointer; padding: 5px 0; font-size: 0.9rem; text-decoration: underline; margin-bottom: 10px;">
                    + Show Addnl Fields
                </button>

                <!-- Optional fields (initially hidden) -->
                <div id="optionalCustomerFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyName">Company Name</label>
                            <input type="text" id="companyName">
                        </div>
                        <div class="form-group">
                            <label for="aptSuite">Apt/Suite</label>
                            <input type="text" id="aptSuite" placeholder="e.g., Suite 100">
                        </div>
                        <div class="form-group">
                            <label for="nearestIntersection">Nearest Intersection</label>
                            <input type="text" id="nearestIntersection" placeholder="e.g., Main St & 5th Ave">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="streetAddress">Street Address</label>
                        <input type="text" id="streetAddress" placeholder="e.g., 123 Main Street">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" placeholder="e.g., Phoenix">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state">
                            <option value="AL">AL</option>
                            <option value="AK">AK</option>
                            <option value="AZ" selected>AZ</option>
                            <option value="AR">AR</option>
                            <option value="CA">CA</option>
                            <option value="CO">CO</option>
                            <option value="CT">CT</option>
                            <option value="DE">DE</option>
                            <option value="FL">FL</option>
                            <option value="GA">GA</option>
                            <option value="HI">HI</option>
                            <option value="ID">ID</option>
                            <option value="IL">IL</option>
                            <option value="IN">IN</option>
                            <option value="IA">IA</option>
                            <option value="KS">KS</option>
                            <option value="KY">KY</option>
                            <option value="LA">LA</option>
                            <option value="ME">ME</option>
                            <option value="MD">MD</option>
                            <option value="MA">MA</option>
                            <option value="MI">MI</option>
                            <option value="MN">MN</option>
                            <option value="MS">MS</option>
                            <option value="MO">MO</option>
                            <option value="MT">MT</option>
                            <option value="NE">NE</option>
                            <option value="NV">NV</option>
                            <option value="NH">NH</option>
                            <option value="NJ">NJ</option>
                            <option value="NM">NM</option>
                            <option value="NY">NY</option>
                            <option value="NC">NC</option>
                            <option value="ND">ND</option>
                            <option value="OH">OH</option>
                            <option value="OK">OK</option>
                            <option value="OR">OR</option>
                            <option value="PA">PA</option>
                            <option value="RI">RI</option>
                            <option value="SC">SC</option>
                            <option value="SD">SD</option>
                            <option value="TN">TN</option>
                            <option value="TX">TX</option>
                            <option value="UT">UT</option>
                            <option value="VT">VT</option>
                            <option value="VA">VA</option>
                            <option value="WA">WA</option>
                            <option value="WV">WV</option>
                            <option value="WI">WI</option>
                            <option value="WY">WY</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="zipCode">ZIP Code</label>
                        <input type="text" id="zipCode" placeholder="e.g., 85001" pattern="[0-9]{5}">
                    </div>
                </div>
            </div>

            <!-- Screen Configuration -->
            <div class="form-section">
                <h2>Screen Configuration</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="screenName">Screen Name (optional)</label>
                        <input type="text" id="screenName" placeholder="e.g., Front Patio, Main Window">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="trackType">Track/System Type *</label>
                        <select id="trackType" required>
                            <option value="">-- Select Track Type --</option>
                            <option value="sunair-zipper">Sunair Zipper Track</option>
                            <option value="sunair-cable">Sunair Cable</option>
                            <option value="fenetex-keder">Fenetex Keder Track</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="operatorType">Operator/Motor *</label>
                        <select id="operatorType" required disabled>
                            <option value="">-- Select Track Type First --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fabricColor">Fabric Color *</label>
                        <select id="fabricColor" required>
                            <option value="">-- Select Fabric Color --</option>
                            <option value="T18FVT061-Espresso">Espresso Texture</option>
                            <option value="T18FVT054-Tobacco">Tobacco</option>
                            <option value="T18FVT061-Charcoal">Charcoal</option>
                            <option value="T18FVT059-Granite">Granite</option>
                            <option value="T18FVT060-Black">Black</option>
                            <option value="T18FVT056-Sable">Sable</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="frameColor">Frame Color *</label>
                        <select id="frameColor" required>
                            <option value="">-- Select Frame Color --</option>
                            <option value="white">White</option>
                            <option value="mocha">Mocha</option>
                            <option value="taupe">Taupe</option>
                            <option value="brown">Brown</option>
                            <option value="bronze">Bronze</option>
                            <option value="black">Black</option>
                            <option value="grey">Grey</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="dimension-group">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #333; font-size: 0.85rem; display: block;">Width *</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <input type="number" id="widthInches" min="0" max="288" step="0.01" placeholder="Inches (e.g., 216.5)" required style="width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                            </div>
                            <div style="flex: 0 0 120px;">
                                <input type="text" id="widthFraction" placeholder="Fraction (3/8)" style="width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                            </div>
                        </div>
                    </div>
                    <div class="dimension-group">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #333; font-size: 0.85rem; display: block;">Height *</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <input type="number" id="heightInches" min="0" max="192" step="0.01" placeholder="Inches (e.g., 96.75)" required style="width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                            </div>
                            <div style="flex: 0 0 120px;">
                                <input type="text" id="heightFraction" placeholder="Fraction (5/8)" style="width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="checkbox-group" id="noTracksGroup" style="display: none;">
                    <input type="checkbox" id="noTracks">
                    <label for="noTracks">No Tracks (Zipper screens only - deduct track costs)</label>
                </div>

                <div class="checkbox-group" id="cableSurchargeInfo" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Note:</strong> First cable screen unit in an order includes a $125 surcharge.
                    </div>
                </div>

                <div id="dimensionsSummary" class="alert alert-info" style="display: none; margin-top: 15px;">
                    <strong>Pricing Dimensions:</strong> <span id="pricingDimensions"></span>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="includeInstallation" checked>
                    <label for="includeInstallation">Include Installation</label>
                </div>
            </div>

            <!-- Accessories -->
            <div class="form-section" id="accessoriesSection">
                <h2>Remotes & Accessories</h2>
                <p class="info-text">Available options will update based on motor type selected</p>
                <div class="accessories-section" id="accessoriesList">
                    <p>Please select a screen type with motor operation to see available accessories.</p>
                </div>
            </div>

            <!-- Comparison and Discount Options -->
            <div class="form-section">
                <h2>Additional Options</h2>

                <div class="checkbox-group">
                    <input type="checkbox" id="enableComparison">
                    <label for="enableComparison">Show Pricing Comparison with Alternative Motor</label>
                </div>

                <div id="comparisonOptions" class="form-row" style="display: none; margin-top: 15px;">
                    <div class="form-group">
                        <label for="comparisonMotor">Compare Against:</label>
                        <select id="comparisonMotor">
                            <option value="">-- Select Motor to Compare --</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="discountLabel">Discount Label (optional)</label>
                        <input type="text" id="discountLabel" placeholder="e.g., Spring Sale, Bulk Discount">
                    </div>
                    <div class="form-group">
                        <label for="discountPercent">Discount Percentage</label>
                        <input type="number" id="discountPercent" min="0" max="100" step="0.1" placeholder="0" value="0">
                        <small style="color: #666; font-size: 0.85rem;">Applied to materials subtotal</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button id="addToOrderBtn" class="btn-primary" onclick="addToOrder()">Add to Order</button>
                <button class="btn-secondary" onclick="resetForm()">Clear Form</button>
            </div>

            <!-- Screens in Order -->
            <div id="screensInOrder" class="form-section hidden">
                <h2>Screens in Order (<span id="screenCount">0</span>)</h2>
                <div id="screensList"></div>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn-primary" onclick="calculateOrderQuote()">Calculate Order Quote</button>
                </div>
            </div>

            <!-- Quote Summary -->
            <div id="quoteSummary" class="quote-summary hidden">
                <h3>Quote Summary</h3>
                <div id="summaryContent"></div>

                <div class="internal-info">
                    <h4>Internal Information (Not shown to customer)</h4>
                    <div id="internalInfo"></div>
                </div>

                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn-success" onclick="saveQuote()">Save Quote</button>
                    <button class="btn-secondary" onclick="generatePDF()">Download PDF</button>
                    <button class="btn-secondary" onclick="emailQuote()">Email Quote</button>
                    <button class="btn-primary" onclick="finalizeProjectDetails()" style="background: #28a745; margin-top: 10px; width: 100%; font-weight: 600;">ðŸŽ¯ Finalize Project Details</button>
                </div>
            </div>

            <!-- Saved Quotes -->
            <div class="saved-quotes">
                <h3>Saved Quotes</h3>
                <div id="savedQuotesList"></div>
            </div>
        </div>
    </div>

    <script>
        // Pricing Data
        const SUNAIR_DISCOUNT = 0.20;
        const CUSTOMER_MARKUP = 1.8;
        const FENETEX_MARKUP = 1.20;
        const CABLE_SURCHARGE = 125;

        // Screens Array for Multi-Screen Orders
        let screensInOrder = [];
        let editingScreenIndex = null;

        // Sunair Zipper Track - Gear Operation Pricing
        const sunairZipperGear = {
            '3': {'4': 763.48, '5': 807.98, '6': 852.49, '7': 896.99, '8': 941.50, '9': 985.99, '10': 1030.50, '11': 1075.01, '12': 1119.51, '13': 1164.02, '14': 1208.52, '15': 1253.02, '16': 1297.53},
            '4': {'4': 855.48, '5': 903.56, '6': 951.64, '7': 999.73, '8': 1047.81, '9': 1095.89, '10': 1143.97, '11': 1192.06, '12': 1240.14, '13': 1288.22, '14': 1336.31, '15': 1384.39, '16': 1432.47},
            '5': {'4': 947.48, '5': 999.14, '6': 1050.80, '7': 1102.46, '8': 1154.12, '9': 1205.78, '10': 1257.45, '11': 1309.11, '12': 1360.77, '13': 1412.43, '14': 1464.09, '15': 1515.75, '16': 1567.41},
            '6': {'4': 1039.48, '5': 1094.72, '6': 1149.96, '7': 1205.20, '8': 1260.44, '9': 1315.68, '10': 1370.92, '11': 1426.16, '12': 1481.40, '13': 1536.64, '14': 1591.88, '15': 1647.12, '16': 1702.36},
            '7': {'4': 1131.48, '5': 1190.30, '6': 1249.11, '7': 1307.93, '8': 1366.75, '9': 1425.57, '10': 1484.39, '11': 1543.21, '12': 1602.03, '13': 1660.84, '14': 1719.66, '15': 1778.48, '16': 1837.30},
            '8': {'4': 1223.48, '5': 1285.87, '6': 1348.27, '7': 1410.67, '8': 1473.07, '9': 1535.46, '10': 1597.86, '11': 1660.26, '12': 1722.65, '13': 1785.05, '14': 1847.45, '15': 1909.84, '16': 1972.24},
            '9': {'4': 1315.48, '5': 1381.45, '6': 1447.43, '7': 1513.40, '8': 1579.38, '9': 1645.36, '10': 1711.33, '11': 1777.31, '12': 1843.28, '13': 1909.26, '14': 1975.23, '15': 2041.21, '16': 2107.18},
            '10': {'4': 1407.48, '5': 1477.03, '6': 1546.59, '7': 1616.14, '8': 1685.69, '9': 1755.25, '10': 1824.80, '11': 1894.36, '12': 1963.91, '13': 2033.46, '14': 2103.02, '15': 2172.57, '16': 2242.13},
            '11': {'4': 1499.48, '5': 1572.61, '6': 1645.74, '7': 1718.88, '8': 1792.01, '9': 1865.14, '10': 1938.27, '11': 2011.41, '12': 2084.54, '13': 2157.67, '14': 2230.80, '15': 2303.94, '16': 2377.07},
            '12': {'4': 1593.40, '5': 1670.11, '6': 1746.82, '7': 1823.54, '8': 1900.25, '9': 1976.96, '10': 2053.67, '11': 2130.38, '12': 2207.09, '13': 2283.80, '14': 2360.52, '15': 2437.23, '16': 2513.94},
            '13': {'4': 1681.55, '5': 1761.84, '6': 1842.13, '7': 1922.42, '8': 2002.71, '9': 2083.00, '10': 2163.29, '11': 2243.58, '12': 2323.87, '13': 2404.16, '14': 2484.45, '15': 2564.74, '16': null},
            '14': {'4': 1769.70, '5': 1853.57, '6': 1937.44, '7': 2021.31, '8': 2105.18, '9': 2189.04, '10': 2272.91, '11': 2356.78, '12': 2440.65, '13': 2524.52, '14': 2608.39, '15': 2692.25, '16': null},
            '15': {'4': 1857.85, '5': 1945.30, '6': 2032.75, '7': 2120.19, '8': 2207.64, '9': 2295.09, '10': 2382.53, '11': 2469.98, '12': 2557.43, '13': 2644.87, '14': 2732.32, '15': 2819.77, '16': null},
            '16': {'4': 1946.00, '5': 2037.03, '6': 2128.05, '7': 2219.08, '8': 2310.10, '9': 2401.13, '10': 2492.15, '11': 2583.18, '12': 2674.21, '13': 2765.23, '14': 2856.26, '15': 2947.28, '16': null},
            '17': {'4': 2005.53, '5': 2099.52, '6': 2193.51, '7': 2287.50, '8': 2381.49, '9': 2475.48, '10': 2569.47, '11': 2663.46, '12': 2757.46, '13': 2851.45, '14': null, '15': null, '16': null},
            '18': {'4': 2092.41, '5': 2189.97, '6': 2287.54, '7': 2385.11, '8': 2482.68, '9': 2580.25, '10': 2677.82, '11': 2775.39, '12': 2872.96, '13': null, '14': null, '15': null, '16': null},
            '19': {'4': 2179.28, '5': 2280.42, '6': 2381.57, '7': 2482.72, '8': 2583.87, '9': 2685.01, '10': 2786.16, '11': 2887.31, '12': null, '13': null, '14': null, '15': null, '16': null},
            '20': {'4': 2266.15, '5': 2370.88, '6': 2475.60, '7': 2580.33, '8': 2685.05, '9': 2789.78, '10': 2894.51, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null},
            '21': {'4': 3153.66, '5': 3269.71, '6': 3385.77, '7': 3501.83, '8': 3617.88, '9': 3733.94, '10': null, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null},
            '22': {'4': 3228.95, '5': 3348.92, '6': 3468.90, '7': 3588.87, '8': 3708.85, '9': 3828.82, '10': null, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null},
            '23': {'4': 3304.23, '5': 3428.13, '6': 3552.02, '7': 3675.91, '8': 3799.81, '9': 3923.70, '10': null, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null},
            '24': {'4': 3379.52, '5': 3507.33, '6': 3635.14, '7': 3762.96, '8': 3890.77, '9': 4018.58, '10': null, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null}
        };

        // Sunair Cable - Gear Operation Pricing
        const sunairCableGear = {
            '3': {'4': 815.31, '5': 816.47, '6': 942.70, '7': 943.87, '8': 945.03, '9': 1071.26, '10': 1072.43, '11': 1073.59, '12': 1199.82, '13': 1200.99, '14': 1202.15, '15': 1328.38, '16': 1329.55},
            '4': {'4': 893.60, '5': 894.77, '6': 1021.00, '7': 1022.16, '8': 1023.33, '9': 1149.56, '10': 1150.72, '11': 1151.89, '12': 1278.12, '13': 1279.28, '14': 1280.45, '15': 1406.68, '16': 1407.84},
            '5': {'4': 971.90, '5': 973.06, '6': 1099.30, '7': 1100.46, '8': 1101.62, '9': 1227.86, '10': 1229.02, '11': 1230.18, '12': 1356.42, '13': 1357.58, '14': 1358.74, '15': 1484.98, '16': 1486.14},
            '6': {'4': 1050.20, '5': 1051.36, '6': 1177.59, '7': 1178.76, '8': 1179.92, '9': 1306.15, '10': 1307.32, '11': 1308.48, '12': 1434.71, '13': 1435.88, '14': 1437.04, '15': 1563.27, '16': 1564.44},
            '7': {'4': 1128.49, '5': 1129.65, '6': 1255.89, '7': 1257.05, '8': 1258.21, '9': 1384.45, '10': 1385.61, '11': 1386.77, '12': 1513.01, '13': 1514.17, '14': 1515.33, '15': 1641.57, '16': 1642.73},
            '8': {'4': 1206.79, '5': 1207.95, '6': 1334.19, '7': 1335.35, '8': 1336.51, '9': 1462.75, '10': 1463.91, '11': 1465.07, '12': 1591.31, '13': 1592.47, '14': 1593.63, '15': 1719.87, '16': 1721.03},
            '9': {'4': 1285.09, '5': 1286.25, '6': 1412.48, '7': 1413.65, '8': 1414.81, '9': 1541.04, '10': 1542.20, '11': 1543.37, '12': 1669.60, '13': 1670.76, '14': 1671.93, '15': 1798.16, '16': 1799.32},
            '10': {'4': 1363.38, '5': 1364.54, '6': 1490.78, '7': 1491.94, '8': 1493.10, '9': 1619.34, '10': 1620.50, '11': 1621.66, '12': 1747.90, '13': 1749.06, '14': 1750.22, '15': 1876.46, '16': 1877.62},
            '11': {'4': 1691.82, '5': 1692.99, '6': 1694.15, '7': 1695.31, '8': 1696.47, '9': 1697.64, '10': 2199.09, '11': 2200.25, '12': 2201.41, '13': 2202.57, '14': 2203.74, '15': 2204.90, '16': 2206.06},
            '12': {'4': 1813.09, '5': 1814.25, '6': 1815.41, '7': 1816.58, '8': 1817.74, '9': 1818.90, '10': 2320.35, '11': 2321.52, '12': 2322.68, '13': 2323.84, '14': 2325.00, '15': 2326.17, '16': 2327.33},
            '13': {'4': 2012.11, '5': 2013.27, '6': 2014.43, '7': 2015.59, '8': 2016.76, '9': 2017.92, '10': 2644.44, '11': 2645.61, '12': 2646.77, '13': 2647.93, '14': 2649.09, '15': 2650.26, '16': 2651.42},
            '14': {'4': 2086.05, '5': 2087.21, '6': 2088.38, '7': 2089.54, '8': 2090.70, '9': 2091.86, '10': 2718.39, '11': 2719.55, '12': 2720.71, '13': 2721.88, '14': 2723.04, '15': 2724.20, '16': 2725.36},
            '15': {'4': 2160.00, '5': 2161.16, '6': 2162.32, '7': 2163.48, '8': 2164.65, '9': 2165.81, '10': 2792.33, '11': 2793.50, '12': 2794.66, '13': 2795.82, '14': 2796.98, '15': null, '16': null},
            '16': {'4': 2359.01, '5': 2360.18, '6': 2361.34, '7': 2362.50, '8': 2363.66, '9': 2364.83, '10': 3116.42, '11': 3117.59, '12': 3118.75, '13': 3119.91, '14': null, '15': null, '16': null},
            '17': {'4': 2362.11, '5': 2363.27, '6': 2364.44, '7': 2365.60, '8': 2366.76, '9': 2367.92, '10': 3119.52, '11': 3120.68, '12': 3121.85, '13': null, '14': null, '15': null, '16': null},
            '18': {'4': 2431.89, '5': 2433.05, '6': 2434.21, '7': 2435.38, '8': 2436.54, '9': 2437.70, '10': 3189.30, '11': 3190.46, '12': null, '13': null, '14': null, '15': null, '16': null},
            '19': {'4': 2626.74, '5': 2627.90, '6': 2629.06, '7': 2630.23, '8': 2631.39, '9': 2632.55, '10': 3509.22, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null},
            '20': {'4': 2696.52, '5': 2697.68, '6': 2698.84, '7': 2700.00, '8': 2701.17, '9': 2702.33, '10': null, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null},
            '21': {'4': 2766.29, '5': 2767.46, '6': 2768.62, '7': 2769.78, '8': 2770.94, '9': null, '10': null, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null},
            '22': {'4': 2961.14, '5': 2962.31, '6': 2963.47, '7': 2964.63, '8': 2965.79, '9': null, '10': null, '11': null, '12': null, '13': null, '14': null, '15': null, '16': null}
        };

        // Fenetex Keder with RTS Motor Pricing
        const fenetexKeder = {
            '3': {'3': 819, '4': 856, '5': 893, '6': 930, '7': 967, '8': 1004, '9': 1041, '10': 1078, '11': 1115, '12': 1152, '13': 1189},
            '4': {'3': 869, '4': 912, '5': 955, '6': 998, '7': 1041, '8': 1084, '9': 1126, '10': 1169, '11': 1212, '12': 1255, '13': 1298},
            '5': {'3': 919, '4': 968, '5': 1017, '6': 1065, '7': 1114, '8': 1163, '9': 1211, '10': 1260, '11': 1309, '12': 1358, '13': 1406},
            '6': {'3': 969, '4': 1024, '5': 1078, '6': 1133, '7': 1187, '8': 1242, '9': 1296, '10': 1351, '11': 1406, '12': 1460, '13': 1515},
            '7': {'3': 987, '4': 1047, '5': 1108, '6': 1168, '7': 1228, '8': 1289, '9': 1349, '10': 1409, '11': 1470, '12': 1530, '13': 1590},
            '8': {'3': 1004, '4': 1071, '5': 1137, '6': 1203, '7': 1269, '8': 1335, '9': 1402, '10': 1468, '11': 1534, '12': 1600, '13': 1666},
            '9': {'3': 1054, '4': 1126, '5': 1198, '6': 1270, '7': 1343, '8': 1415, '9': 1487, '10': 1559, '11': 1631, '12': 1703, '13': 1710},
            '10': {'3': 1104, '4': 1182, '5': 1260, '6': 1338, '7': 1416, '8': 1494, '9': 1572, '10': 1650, '11': 1727, '12': 1805, '13': 1883},
            '11': {'3': 1154, '4': 1238, '5': 1322, '6': 1406, '7': 1489, '8': 1573, '9': 1657, '10': 1740, '11': 1824, '12': 1908, '13': 1991},
            '12': {'3': 1204, '4': 1294, '5': 1384, '6': 1473, '7': 1563, '8': 1652, '9': 1742, '10': 1831, '11': 1921, '12': 2010, '13': 2100},
            '13': {'3': 1254, '4': 1350, '5': 1445, '6': 1541, '7': 1636, '8': 1731, '9': 1827, '10': 1922, '11': 2017, '12': 2113, '13': 2208},
            '14': {'3': 1304, '4': 1406, '5': 1507, '6': 1608, '7': 1709, '8': 1811, '9': 1912, '10': 2013, '11': 2114, '12': 2215, '13': 2317},
            '15': {'3': 1354, '4': 1462, '5': 1569, '6': 1676, '7': 1783, '8': 1890, '9': 1997, '10': 2104, '11': 2211, '12': 2318, '13': 2425},
            '16': {'3': 1404, '4': 1517, '5': 1630, '6': 1743, '7': 1856, '8': 1969, '9': 2082, '10': 2195, '11': 2308, '12': 2421, '13': 2533},
            '17': {'3': 1454, '4': 1573, '5': 1692, '6': 1811, '7': 1929, '8': 2048, '9': 2167, '10': 2286, '11': 2404, '12': 2523, '13': 2642},
            '18': {'3': 1504, '4': 1629, '5': 1754, '6': 1878, '7': 2003, '8': 2127, '9': 2252, '10': 2376, '11': 2501, '12': 2626, '13': 2750},
            '19': {'3': 1555, '4': 1685, '5': 1815, '6': 1946, '7': 2076, '8': 2207, '9': 2337, '10': 2467, '11': 2598, '12': 2728, '13': 2859},
            '20': {'3': 1605, '4': 1741, '5': 1877, '6': 2013, '7': 2149, '8': 2286, '9': 2422, '10': 2558, '11': 2694, '12': 2831, '13': 2967}
        };

        // Motor and Accessory Costs
        const motorCosts = {
            'gaposa-rts': 225,
            'gaposa-solar': 425,
            'somfy-rts': 375
        };

        const accessories = {
            'gaposa': [
                {id: 'gaposa-solar-ext', name: 'Solar Motor 10ft Extension Cord', cost: 60, markup: true},
                {id: 'gaposa-1ch-handheld', name: 'Single Channel Handheld Remote', cost: 50, markup: true},
                {id: 'gaposa-5ch-handheld', name: '5-Channel Handheld Remote', cost: 75, markup: true},
                {id: 'gaposa-1ch-wall', name: 'Single Channel On-Wall Remote', cost: 96, markup: false},
                {id: 'gaposa-5ch-wall', name: '5-Channel On-Wall Remote', cost: 115, markup: false},
                {id: 'gaposa-16ch-handheld', name: '16-Channel Handheld Remote', cost: 287, markup: false},
                {id: 'gaposa-keypad', name: 'Digital Keypad', cost: 229, markup: false}
            ],
            'somfy': [
                {id: 'somfy-1ch-indoor', name: 'Single Channel Handheld Remote (Indoor)', cost: 61, markup: true},
                {id: 'somfy-5ch-indoor', name: '5-Channel Handheld Remote (Indoor)', cost: 80, markup: true},
                {id: 'somfy-1ch-outdoor', name: 'Single Channel Handheld Remote (Outdoor)', cost: 84, markup: true},
                {id: 'somfy-5ch-outdoor', name: '5-Channel Handheld Remote (Outdoor)', cost: 117, markup: true},
                {id: 'somfy-16ch', name: '16-Channel Handheld Remote (Indoor)', cost: 275, markup: true},
                {id: 'somfy-1ch-wall', name: 'Single Channel In-Wall Remote', cost: 79, markup: true},
                {id: 'somfy-5ch-wall', name: '5-Channel In-Wall Remote', cost: 99, markup: true}
            ]
        };

        // Track deduction costs by height
        const trackDeductions = {
            '4': -99.89,
            '5': -117.98,
            '6': -136.07,
            '7': -154.16,
            '8': -172.25,
            '9': -190.34,
            '10': -208.43,
            '11': -226.51,
            '12': -244.60,
            '13': -262.69,
            '14': -280.78,
            '15': -298.87,
            '16': -316.96
        };

        // Installation pricing
        const installationPricing = {
            'rts-small': 525,
            'solar-small': 400,
            'rts-large': 700,
            'solar-large': 600
        };

        // Load saved quotes on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedQuotes();

            // Toggle optional customer fields
            document.getElementById('toggleOptionalFields').addEventListener('click', function() {
                const optionalFields = document.getElementById('optionalCustomerFields');
                const isHidden = optionalFields.style.display === 'none';

                if (isHidden) {
                    optionalFields.style.display = 'block';
                    this.textContent = 'âˆ’ Hide Addnl Fields';
                } else {
                    optionalFields.style.display = 'none';
                    this.textContent = '+ Show Addnl Fields';
                }
            });

            // Update operator options when track type changes
            document.getElementById('trackType').addEventListener('change', function() {
                const trackType = this.value;
                const operatorSelect = document.getElementById('operatorType');
                const noTracksGroup = document.getElementById('noTracksGroup');
                const cableSurchargeInfo = document.getElementById('cableSurchargeInfo');

                operatorSelect.innerHTML = '<option value="">-- Select Operator --</option>';
                operatorSelect.disabled = false;

                if (trackType === 'sunair-zipper') {
                    operatorSelect.innerHTML += `
                        <option value="gear">Gear Operation (Manual)</option>
                        <option value="gaposa-rts">Gaposa RTS Motor</option>
                        <option value="gaposa-solar">Gaposa Solar Motor</option>
                        <option value="somfy-rts">Somfy RTS Motor</option>
                    `;
                    noTracksGroup.style.display = 'flex';
                    cableSurchargeInfo.style.display = 'none';
                } else if (trackType === 'sunair-cable') {
                    operatorSelect.innerHTML += `
                        <option value="gear">Gear Operation (Manual)</option>
                        <option value="gaposa-rts">Gaposa RTS Motor</option>
                        <option value="gaposa-solar">Gaposa Solar Motor</option>
                        <option value="somfy-rts">Somfy RTS Motor</option>
                    `;
                    noTracksGroup.style.display = 'none';
                    document.getElementById('noTracks').checked = false;
                    cableSurchargeInfo.style.display = 'block';
                } else if (trackType === 'fenetex-keder') {
                    operatorSelect.innerHTML += `
                        <option value="gaposa-rts">Gaposa RTS Motor (Included)</option>
                    `;
                    noTracksGroup.style.display = 'none';
                    document.getElementById('noTracks').checked = false;
                    cableSurchargeInfo.style.display = 'none';
                } else {
                    operatorSelect.disabled = true;
                    noTracksGroup.style.display = 'none';
                    cableSurchargeInfo.style.display = 'none';
                }

                // Clear operator selection
                operatorSelect.value = '';
                updateAccessories();
            });

            // Update accessories when operator type changes
            document.getElementById('operatorType').addEventListener('change', function() {
                updateAccessories();
                updateComparisonOptions();
            });

            // Update pricing dimensions when measurements change
            ['widthInches', 'widthFraction', 'heightInches', 'heightFraction'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePricingDimensions);
            });

            // Enable/disable comparison options
            document.getElementById('enableComparison').addEventListener('change', function() {
                const comparisonOptions = document.getElementById('comparisonOptions');
                comparisonOptions.style.display = this.checked ? 'grid' : 'none';
                if (!this.checked) {
                    document.getElementById('comparisonMotor').value = '';
                }
            });
        });

        function parseFraction(fractionStr) {
            if (!fractionStr || fractionStr.trim() === '') return 0;

            const parts = fractionStr.trim().split('/');
            if (parts.length === 2) {
                const numerator = parseFloat(parts[0]);
                const denominator = parseFloat(parts[1]);
                if (denominator !== 0 && !isNaN(numerator) && !isNaN(denominator)) {
                    return numerator / denominator;
                }
            }
            return 0;
        }

        function inchesToFeetAndInches(totalInches) {
            const feet = Math.floor(totalInches / 12);
            const inches = totalInches % 12;

            // Round inches to nearest 1/8
            const roundedInches = Math.round(inches * 8) / 8;

            if (roundedInches === 12) {
                return `${feet + 1}' 0"`;
            }

            return `${feet}' ${roundedInches.toFixed(3).replace(/\.?0+$/, '')}"`;
        }

        function formatCurrency(amount) {
            return '$' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function getClientFacingOperatorName(operatorType, operatorTypeName) {
            // Remove brand names from motor descriptions for client-facing display
            if (operatorType === 'gear') {
                return 'Manual Gear Operation';
            }
            if (operatorType === 'gaposa-rts') {
                return 'Remote-Operated Motor';
            }
            if (operatorType === 'gaposa-solar') {
                return 'Solar Motor';
            }
            if (operatorType === 'somfy-rts') {
                return 'Somfy Remote-Operated Motor';
            }
            return operatorTypeName;
        }

        function getClientFacingTrackName(trackTypeName) {
            // Remove brand names from track descriptions
            return trackTypeName.replace('Sunair ', '').replace('Fenetex ', '');
        }

        function updatePricingDimensions() {
            const widthInches = parseFloat(document.getElementById('widthInches').value) || 0;
            const widthFraction = parseFraction(document.getElementById('widthFraction').value);
            const heightInches = parseFloat(document.getElementById('heightInches').value) || 0;
            const heightFraction = parseFraction(document.getElementById('heightFraction').value);

            const totalWidthInches = widthInches + widthFraction;
            const totalHeightInches = heightInches + heightFraction;

            if (totalWidthInches > 0 || totalHeightInches > 0) {
                const widthDisplay = inchesToFeetAndInches(totalWidthInches);
                const heightDisplay = inchesToFeetAndInches(totalHeightInches);

                const pricingWidth = Math.round(totalWidthInches / 12);
                const pricingHeight = Math.round(totalHeightInches / 12);

                document.getElementById('pricingDimensions').textContent =
                    `${widthDisplay} W x ${heightDisplay} H (pricing based on ${pricingWidth}' x ${pricingHeight}')`;
                document.getElementById('dimensionsSummary').style.display = 'block';
            } else {
                document.getElementById('dimensionsSummary').style.display = 'none';
            }
        }

        function updateComparisonOptions() {
            const operatorType = document.getElementById('operatorType').value;
            const trackType = document.getElementById('trackType').value;
            const comparisonMotor = document.getElementById('comparisonMotor');

            comparisonMotor.innerHTML = '<option value="">-- Select Motor to Compare --</option>';

            if (!trackType || !operatorType || operatorType === 'gear') {
                return;
            }

            // Build list of alternative motors based on current selection
            const motorOptions = [];

            if (trackType === 'sunair-zipper' || trackType === 'sunair-cable') {
                if (operatorType !== 'gaposa-rts') {
                    motorOptions.push({value: 'gaposa-rts', label: 'Remote-Operated Motor'});
                }
                if (operatorType !== 'gaposa-solar') {
                    motorOptions.push({value: 'gaposa-solar', label: 'Solar Motor'});
                }
                if (operatorType !== 'somfy-rts') {
                    motorOptions.push({value: 'somfy-rts', label: 'Somfy Remote-Operated Motor'});
                }
            }

            motorOptions.forEach(opt => {
                comparisonMotor.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
            });
        }

        function calculateScreenWithAlternateMotor(screen, alternateMotorType) {
            // Calculate what the screen would cost with a different motor
            let alternateMotorCost = 0;

            if (alternateMotorType === 'gaposa-rts') {
                alternateMotorCost = motorCosts['gaposa-rts'];
            } else if (alternateMotorType === 'gaposa-solar') {
                alternateMotorCost = motorCosts['gaposa-solar'];
            } else if (alternateMotorType === 'somfy-rts') {
                alternateMotorCost = motorCosts['somfy-rts'];
            }

            // Start with screen-only cost (no motor)
            let screenOnlyCost = screen.screenCostOnly;

            // Add track deduction if applicable
            if (screen.trackDeduction) {
                screenOnlyCost += screen.trackDeduction;
            }

            // Add accessories cost
            let accessoriesCost = 0;
            screen.accessories.forEach(acc => {
                accessoriesCost += acc.cost;
            });

            // Calculate customer price with alternate motor
            let customerPrice = screenOnlyCost * CUSTOMER_MARKUP;
            customerPrice += alternateMotorCost * CUSTOMER_MARKUP;

            // Add back track deduction after markup
            if (screen.trackDeduction) {
                customerPrice += screen.trackDeduction;
            }

            // Add accessories with their proper markup
            screen.accessories.forEach(acc => {
                if (acc.needsMarkup) {
                    customerPrice += acc.cost * CUSTOMER_MARKUP;
                } else {
                    customerPrice += acc.cost;
                }
            });

            // Add installation (same for all motor types with same size/type)
            customerPrice += screen.installationPrice;

            return {
                customerPrice: customerPrice,
                motorCost: alternateMotorCost,
                materialPrice: customerPrice - screen.installationPrice
            };
        }

        function updateAccessories() {
            const operatorType = document.getElementById('operatorType').value;
            const accessoriesList = document.getElementById('accessoriesList');

            let motorType = null;
            if (operatorType === 'gaposa-rts' || operatorType === 'gaposa-solar') {
                motorType = 'gaposa';
            } else if (operatorType === 'somfy-rts') {
                motorType = 'somfy';
            }

            if (!motorType) {
                accessoriesList.innerHTML = '<p>Please select a motorized operator to see available accessories.</p>';
                return;
            }

            let availableAccessories = accessories[motorType];

            // Filter out extension cord for non-solar motors
            if (operatorType !== 'gaposa-solar') {
                availableAccessories = availableAccessories.filter(acc => acc.id !== 'gaposa-solar-ext');
            }

            let html = '';

            availableAccessories.forEach(acc => {
                html += `
                    <div class="accessory-item">
                        <input type="checkbox" id="${acc.id}" data-cost="${acc.cost}" data-markup="${acc.markup}" data-name="${acc.name}">
                        <label for="${acc.id}">${acc.name}</label>
                    </div>
                `;
            });

            accessoriesList.innerHTML = html;
        }

        function calculateQuote() {
            // Get form values
            const customerName = document.getElementById('customerName').value;
            const trackType = document.getElementById('trackType').value;
            const operatorType = document.getElementById('operatorType').value;
            const noTracks = document.getElementById('noTracks').checked;
            const includeInstallation = document.getElementById('includeInstallation').checked;

            // Get dimensions
            const widthInches = parseFloat(document.getElementById('widthInches').value) || 0;
            const widthFraction = parseFraction(document.getElementById('widthFraction').value);
            const heightInches = parseFloat(document.getElementById('heightInches').value) || 0;
            const heightFraction = parseFraction(document.getElementById('heightFraction').value);

            // Calculate total inches and round to nearest foot for pricing
            const totalWidthInches = widthInches + widthFraction;
            const totalHeightInches = heightInches + heightFraction;
            const width = Math.round(totalWidthInches / 12);
            const height = Math.round(totalHeightInches / 12);

            // Store actual dimensions for display
            const actualWidthDisplay = inchesToFeetAndInches(totalWidthInches);
            const actualHeightDisplay = inchesToFeetAndInches(totalHeightInches);

            // Validation
            if (!customerName || !trackType || !operatorType) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            if (totalWidthInches === 0 || totalHeightInches === 0) {
                alert('Please enter valid screen dimensions');
                return;
            }

            // Build screen type identifier
            const screenType = `${trackType}-${operatorType}`;

            // Calculate base screen cost
            let baseCost = 0;
            let screenCostOnly = 0;
            let priceData = null;
            let motorCost = 0;
            let isFenetex = false;

            if (trackType === 'sunair-zipper') {
                priceData = sunairZipperGear;
            } else if (trackType === 'sunair-cable') {
                priceData = sunairCableGear;
                baseCost += CABLE_SURCHARGE; // Add cable surcharge
            } else if (trackType === 'fenetex-keder') {
                priceData = fenetexKeder;
                isFenetex = true;
            }

            // Get screen cost from pricing matrix
            if (priceData && priceData[width] && priceData[width][height] !== null && priceData[width][height] !== undefined) {
                let screenCost = priceData[width][height];

                // Apply Sunair discount for non-Fenetex screens
                if (!isFenetex) {
                    screenCost = screenCost * (1 - SUNAIR_DISCOUNT);
                }

                screenCostOnly = screenCost;
                baseCost += screenCost;
            } else {
                alert(`Invalid screen dimensions. No pricing available for ${width}' W x ${height}' H. Please check the size and try again.`);
                return;
            }

            // Add motor cost for motorized options
            if (operatorType === 'gaposa-rts') {
                motorCost = motorCosts['gaposa-rts'];
            } else if (operatorType === 'gaposa-solar') {
                motorCost = motorCosts['gaposa-solar'];
            } else if (operatorType === 'somfy-rts') {
                motorCost = motorCosts['somfy-rts'];
            }

            // For Fenetex, RTS motor is already included in pricing
            if (!isFenetex && motorCost > 0) {
                baseCost += motorCost;
            }

            // Apply track deduction if selected
            let trackDeduction = 0;
            if (noTracks && trackDeductions[height]) {
                trackDeduction = trackDeductions[height] * (1 - SUNAIR_DISCOUNT);
                baseCost += trackDeduction;
            }

            // Calculate accessories cost
            let accessoriesCost = 0;
            const checkboxes = document.querySelectorAll('.accessory-item input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                let accCost = parseFloat(cb.dataset.cost);
                const needsDiscount = cb.dataset.markup === 'true';
                if (needsDiscount) {
                    accCost = accCost * (1 - SUNAIR_DISCOUNT);
                }
                accessoriesCost += accCost;
            });

            let totalCost = baseCost + accessoriesCost;

            // Apply markup to get customer price
            let customerPrice = 0;
            if (isFenetex) {
                // For Fenetex, use Sunair Zipper RTS price for that size + 20%
                const sunairScreenCost = sunairZipperGear[width] && sunairZipperGear[width][height]
                    ? sunairZipperGear[width][height] * (1 - SUNAIR_DISCOUNT)
                    : 0;
                const sunairRTSMotor = motorCosts['gaposa-rts'];

                // Apply markup: (screen * 1.8 + motor * 1.8) * 1.2
                customerPrice = (sunairScreenCost + sunairRTSMotor) * CUSTOMER_MARKUP * FENETEX_MARKUP;

                // Add accessories with their proper markup
                checkboxes.forEach(cb => {
                    let accCost = parseFloat(cb.dataset.cost);
                    const needsMarkup = cb.dataset.markup === 'true';
                    if (needsMarkup) {
                        accCost = accCost * (1 - SUNAIR_DISCOUNT) * CUSTOMER_MARKUP;
                    }
                    customerPrice += accCost;
                });
            } else {
                // Standard Sunair pricing - separate screen and motor markup
                // Screen cost (with any cable surcharge) gets discounted and marked up
                let screenOnlyCost = baseCost - motorCost;

                // Handle track deduction
                if (noTracks) {
                    screenOnlyCost -= trackDeduction; // Remove track deduction from markup base
                }

                // Apply 1.8x markup to screen
                customerPrice = screenOnlyCost * CUSTOMER_MARKUP;

                // Add motor with 1.8x markup (motor cost is already special price, no discount)
                customerPrice += motorCost * CUSTOMER_MARKUP;

                // Add back track deduction (negative value) after markup
                if (noTracks) {
                    customerPrice += trackDeduction;
                }

                // Add accessories with their proper markup
                checkboxes.forEach(cb => {
                    let accCost = parseFloat(cb.dataset.cost);
                    const needsMarkup = cb.dataset.markup === 'true';
                    if (needsMarkup) {
                        accCost = accCost * (1 - SUNAIR_DISCOUNT) * CUSTOMER_MARKUP;
                    }
                    customerPrice += accCost;
                });
            }

            // Calculate installation
            let installationCost = 0;
            let installationPrice = 0;
            if (includeInstallation) {
                const isLarge = width >= 12;
                const isSolar = operatorType === 'gaposa-solar';

                if (isLarge) {
                    installationPrice = isSolar ? installationPricing['solar-large'] : installationPricing['rts-large'];
                } else {
                    installationPrice = isSolar ? installationPricing['solar-small'] : installationPricing['rts-small'];
                }

                installationCost = installationPrice * 0.7; // Cost to company (70% to installer)
                customerPrice += installationPrice;
            }

            const totalProfit = customerPrice - totalCost - installationCost;
            const marginPercent = (totalProfit / customerPrice) * 100;

            // Display quote summary
            displayQuoteSummary({
                customerName,
                trackType,
                operatorType,
                screenType,
                width,
                height,
                actualWidthDisplay,
                actualHeightDisplay,
                noTracks,
                includeInstallation,
                screenCostOnly,
                motorCost,
                baseCost,
                accessoriesCost,
                totalCost,
                installationCost,
                installationPrice,
                customerPrice,
                totalProfit,
                marginPercent,
                isFenetex
            });
        }

        function displayQuoteSummary(quote) {
            const summaryContent = document.getElementById('summaryContent');
            const internalInfo = document.getElementById('internalInfo');
            const quoteSummary = document.getElementById('quoteSummary');

            const trackTypeName = document.getElementById('trackType').selectedOptions[0].text;
            const operatorTypeName = document.getElementById('operatorType').selectedOptions[0].text;
            const fabricColor = document.getElementById('fabricColor').selectedOptions[0].text;

            // Build address display
            let addressParts = [];
            if (quote.streetAddress) addressParts.push(quote.streetAddress);
            if (quote.aptSuite) addressParts.push(quote.aptSuite);
            const addressLine1 = addressParts.join(', ');

            let cityStateZip = [];
            if (quote.city) cityStateZip.push(quote.city);
            if (quote.state) cityStateZip.push(quote.state);
            const addressLine2 = cityStateZip.join(', ');
            if (quote.zipCode) addressLine2 ? addressLine2 += ' ' + quote.zipCode : quote.zipCode;

            const fullAddress = [addressLine1, addressLine2].filter(x => x).join('<br>');

            // Customer-facing summary
            let customerHTML = `
                <div class="summary-row">
                    <strong>Customer:</strong>
                    <span>${quote.customerName}${quote.companyName ? ' (' + quote.companyName + ')' : ''}</span>
                </div>
                ${fullAddress ? `<div class="summary-row">
                    <strong>Project Address:</strong>
                    <span>${fullAddress}</span>
                </div>` : ''}
                ${quote.nearestIntersection ? `<div class="summary-row">
                    <strong>Nearest Intersection:</strong>
                    <span>${quote.nearestIntersection}</span>
                </div>` : ''}
                <div class="summary-row">
                    <strong>Track System:</strong>
                    <span>${trackTypeName}</span>
                </div>
                <div class="summary-row">
                    <strong>Operator:</strong>
                    <span>${operatorTypeName}</span>
                </div>
                <div class="summary-row">
                    <strong>Fabric Color:</strong>
                    <span>${fabricColor}</span>
                </div>
                <div class="summary-row">
                    <strong>Frame Color:</strong>
                    <span>${quote.frameColorName || 'Not specified'}</span>
                </div>
                <div class="summary-row">
                    <strong>Dimensions:</strong>
                    <span>${quote.actualWidthDisplay} W x ${quote.actualHeightDisplay} H</span>
                </div>
            `;

            if (quote.noTracks) {
                customerHTML += `
                    <div class="summary-row">
                        <strong>Configuration:</strong>
                        <span>No Tracks</span>
                    </div>
                `;
            }

            const selectedAccessories = Array.from(document.querySelectorAll('.accessory-item input[type="checkbox"]:checked'))
                .map(cb => cb.nextElementSibling.textContent);

            if (selectedAccessories.length > 0) {
                customerHTML += `
                    <div class="summary-row">
                        <strong>Accessories:</strong>
                        <span>${selectedAccessories.join(', ')}</span>
                    </div>
                `;
            }

            if (quote.includeInstallation) {
                customerHTML += `
                    <div class="summary-row">
                        <strong>Installation:</strong>
                        <span>$${quote.installationPrice.toFixed(2)}</span>
                    </div>
                `;
            }

            customerHTML += `
                <div class="summary-row total">
                    <strong>Total Price:</strong>
                    <span>$${quote.customerPrice.toFixed(2)}</span>
                </div>
            `;

            summaryContent.innerHTML = customerHTML;

            // Internal information with separated costs
            let internalHTML = `
                <div class="summary-row">
                    <strong>Pricing Dimensions:</strong>
                    <span>${quote.width}' W x ${quote.height}' H (rounded from actual)</span>
                </div>
                <div class="summary-row">
                    <strong>Screen Cost (base):</strong>
                    <span>$${quote.screenCostOnly.toFixed(2)}</span>
                </div>
            `;

            if (quote.motorCost > 0 && !quote.isFenetex) {
                internalHTML += `
                    <div class="summary-row">
                        <strong>Motor Cost:</strong>
                        <span>$${quote.motorCost.toFixed(2)}</span>
                    </div>
                `;
            }

            if (quote.isFenetex) {
                internalHTML += `
                    <div class="summary-row">
                        <strong>Motor Cost:</strong>
                        <span>Included in screen price</span>
                    </div>
                `;
            }

            internalHTML += `
                <div class="summary-row">
                    <strong>Total Screen + Motor:</strong>
                    <span>$${quote.baseCost.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <strong>Accessories Cost:</strong>
                    <span>$${quote.accessoriesCost.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <strong>Installation Cost:</strong>
                    <span>$${quote.installationCost.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <strong>Total Cost:</strong>
                    <span>$${(quote.totalCost + quote.installationCost).toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <strong>Profit:</strong>
                    <span>$${quote.totalProfit.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <strong>Margin:</strong>
                    <span>${quote.marginPercent.toFixed(1)}%</span>
                </div>
            `;

            internalInfo.innerHTML = internalHTML;
            quoteSummary.classList.remove('hidden');

            // Scroll to summary
            quoteSummary.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function saveQuote() {
            const customerName = document.getElementById('customerName').value;
            if (!customerName) {
                alert('Please calculate a quote first');
                return;
            }

            const quoteSummary = document.getElementById('quoteSummary');
            if (quoteSummary.classList.contains('hidden')) {
                alert('Please calculate a quote first');
                return;
            }

            // Get current quote data
            const quoteData = {
                id: Date.now(),
                date: new Date().toISOString(),
                customerName: document.getElementById('customerName').value,
                companyName: document.getElementById('companyName').value,
                customerEmail: document.getElementById('customerEmail').value,
                customerPhone: document.getElementById('customerPhone').value,
                streetAddress: document.getElementById('streetAddress').value,
                aptSuite: document.getElementById('aptSuite').value,
                nearestIntersection: document.getElementById('nearestIntersection').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zipCode: document.getElementById('zipCode').value,
                trackType: document.getElementById('trackType').value,
                trackTypeName: document.getElementById('trackType').selectedOptions[0].text,
                operatorType: document.getElementById('operatorType').value,
                operatorTypeName: document.getElementById('operatorType').selectedOptions[0].text,
                fabricColor: document.getElementById('fabricColor').value,
                fabricColorName: document.getElementById('fabricColor').selectedOptions[0].text,
                frameColor: document.getElementById('frameColor').value,
                frameColorName: document.getElementById('frameColor').selectedOptions[0].text,
                widthInches: document.getElementById('widthInches').value,
                widthFraction: document.getElementById('widthFraction').value,
                heightInches: document.getElementById('heightInches').value,
                heightFraction: document.getElementById('heightFraction').value,
                noTracks: document.getElementById('noTracks').checked,
                includeInstallation: document.getElementById('includeInstallation').checked,
                accessories: Array.from(document.querySelectorAll('.accessory-item input[type="checkbox"]:checked'))
                    .map(cb => ({id: cb.id, name: cb.nextElementSibling.textContent})),
                summaryHTML: document.getElementById('summaryContent').innerHTML,
                internalHTML: document.getElementById('internalInfo').innerHTML
            };

            // Save to localStorage
            let savedQuotes = JSON.parse(localStorage.getItem('screenQuotes') || '[]');
            savedQuotes.unshift(quoteData);
            localStorage.setItem('screenQuotes', JSON.stringify(savedQuotes));

            alert('Quote saved successfully!');
            loadSavedQuotes();
        }

        function loadSavedQuotes() {
            const savedQuotes = JSON.parse(localStorage.getItem('screenQuotes') || '[]');
            const savedQuotesList = document.getElementById('savedQuotesList');

            if (savedQuotes.length === 0) {
                savedQuotesList.innerHTML = '<p style="color: #666;">No saved quotes yet.</p>';
                return;
            }

            let html = '';
            savedQuotes.forEach(quote => {
                const date = new Date(quote.date).toLocaleDateString();
                const displayTrack = quote.trackTypeName || 'N/A';
                const displayOperator = quote.operatorTypeName || 'N/A';

                let displaySize;
                if (quote.widthInches !== undefined) {
                    const totalWidth = parseFloat(quote.widthInches) + parseFraction(quote.widthFraction || '');
                    const totalHeight = parseFloat(quote.heightInches) + parseFraction(quote.heightFraction || '');
                    displaySize = `${inchesToFeetAndInches(totalWidth)} x ${inchesToFeetAndInches(totalHeight)}`;
                } else if (quote.widthFeet !== undefined) {
                    // Legacy format
                    displaySize = `${quote.widthFeet}' ${quote.widthInches}" x ${quote.heightFeet}' ${quote.heightInches}"`;
                } else {
                    displaySize = 'N/A';
                }

                html += `
                    <div class="quote-card">
                        <h4>${quote.customerName}</h4>
                        <p><strong>Date:</strong> ${date}</p>
                        <p><strong>Track:</strong> ${displayTrack}</p>
                        <p><strong>Operator:</strong> ${displayOperator}</p>
                        <p><strong>Size:</strong> ${displaySize}</p>
                        <div class="quote-card-actions">
                            <button class="btn-primary" onclick="loadQuote(${quote.id})">Load</button>
                            <button class="btn-secondary" onclick="deleteQuote(${quote.id})">Delete</button>
                        </div>
                    </div>
                `;
            });

            savedQuotesList.innerHTML = html;
        }

        function loadQuote(quoteId) {
            const savedQuotes = JSON.parse(localStorage.getItem('screenQuotes') || '[]');
            const quote = savedQuotes.find(q => q.id === quoteId);

            if (!quote) return;

            // Populate form
            document.getElementById('customerName').value = quote.customerName;
            document.getElementById('companyName').value = quote.companyName || '';
            document.getElementById('customerEmail').value = quote.customerEmail || '';
            document.getElementById('customerPhone').value = quote.customerPhone || '';
            document.getElementById('streetAddress').value = quote.streetAddress || '';
            document.getElementById('aptSuite').value = quote.aptSuite || '';
            document.getElementById('nearestIntersection').value = quote.nearestIntersection || '';
            document.getElementById('city').value = quote.city || '';
            document.getElementById('state').value = quote.state || '';
            document.getElementById('zipCode').value = quote.zipCode || '';

            // Show optional fields if any have values
            if (quote.companyName || quote.aptSuite || quote.nearestIntersection) {
                document.getElementById('optionalCustomerFields').style.display = 'block';
                document.getElementById('toggleOptionalFields').textContent = 'âˆ’ Hide Addnl Fields';
            }

            // Handle new format (with trackType/operatorType) and old format (with screenType)
            if (quote.trackType && quote.operatorType) {
                document.getElementById('trackType').value = quote.trackType;
                // Trigger change event to populate operator options
                document.getElementById('trackType').dispatchEvent(new Event('change'));
                setTimeout(() => {
                    document.getElementById('operatorType').value = quote.operatorType;
                    document.getElementById('operatorType').dispatchEvent(new Event('change'));
                }, 50);
            }

            document.getElementById('fabricColor').value = quote.fabricColor;
            document.getElementById('frameColor').value = quote.frameColor || '';

            // Handle new format (inches + fractions) and old formats
            if (quote.widthInches !== undefined && quote.heightInches !== undefined) {
                document.getElementById('widthInches').value = quote.widthInches;
                document.getElementById('widthFraction').value = quote.widthFraction || '';
                document.getElementById('heightInches').value = quote.heightInches;
                document.getElementById('heightFraction').value = quote.heightFraction || '';
                updatePricingDimensions();
            } else if (quote.widthFeet !== undefined) {
                // Legacy format with feet/inches - convert to total inches
                const totalWidth = (parseFloat(quote.widthFeet) * 12) + parseFloat(quote.widthInches || 0);
                const totalHeight = (parseFloat(quote.heightFeet) * 12) + parseFloat(quote.heightInches || 0);
                document.getElementById('widthInches').value = Math.floor(totalWidth);
                document.getElementById('widthFraction').value = '';
                document.getElementById('heightInches').value = Math.floor(totalHeight);
                document.getElementById('heightFraction').value = '';
                updatePricingDimensions();
            }

            document.getElementById('noTracks').checked = quote.noTracks;
            document.getElementById('includeInstallation').checked = quote.includeInstallation;

            // Check saved accessories
            setTimeout(() => {
                quote.accessories.forEach(acc => {
                    const checkbox = document.getElementById(acc.id);
                    if (checkbox) checkbox.checked = true;
                });
            }, 150);

            // Display summary
            document.getElementById('summaryContent').innerHTML = quote.summaryHTML;
            document.getElementById('internalInfo').innerHTML = quote.internalHTML;
            document.getElementById('quoteSummary').classList.remove('hidden');

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteQuote(quoteId) {
            if (!confirm('Are you sure you want to delete this quote?')) return;

            let savedQuotes = JSON.parse(localStorage.getItem('screenQuotes') || '[]');
            savedQuotes = savedQuotes.filter(q => q.id !== quoteId);
            localStorage.setItem('screenQuotes', JSON.stringify(savedQuotes));

            loadSavedQuotes();
        }

        function generatePDF() {
            const quoteSummary = document.getElementById('quoteSummary');
            if (quoteSummary.classList.contains('hidden')) {
                alert('Please calculate a quote first');
                return;
            }

            // Hide internal info temporarily
            const internalInfo = document.querySelector('.internal-info');
            const buttonGroup = document.querySelector('.button-group');
            internalInfo.style.display = 'none';
            buttonGroup.style.display = 'none';

            window.print();

            // Restore
            setTimeout(() => {
                internalInfo.style.display = 'block';
                buttonGroup.style.display = 'flex';
            }, 1000);
        }

        function finalizeProjectDetails() {
            // Check if order has been calculated
            if (!window.currentOrderData || !window.currentOrderData.screens || window.currentOrderData.screens.length === 0) {
                alert('Please calculate an order quote first before finalizing project details.');
                return;
            }

            // Store order data temporarily for the finalize page
            localStorage.setItem('tempOrderForFinalize', JSON.stringify(window.currentOrderData));

            // Navigate to finalize page
            window.location.href = `finalize.html?orderId=${window.currentOrderData.id || Date.now()}`;
        }

        function emailQuote() {
            const customerEmail = document.getElementById('customerEmail').value;
            const customerName = document.getElementById('customerName').value;

            if (!customerEmail) {
                alert('Please enter a customer email address');
                return;
            }

            const quoteSummary = document.getElementById('quoteSummary');
            if (quoteSummary.classList.contains('hidden')) {
                alert('Please calculate a quote first');
                return;
            }

            // Get quote details
            const summaryText = document.getElementById('summaryContent').innerText;

            const subject = encodeURIComponent(`Screen Quote for ${customerName}`);
            const body = encodeURIComponent(`Dear ${customerName},\n\nThank you for your interest in Roll-A-Shield custom rolling screens.\n\nHere is your quote:\n\n${summaryText}\n\nPlease let us know if you have any questions.\n\nBest regards,\nRoll-A-Shield Team`);

            window.location.href = `mailto:${customerEmail}?subject=${subject}&body=${body}`;
        }

        function resetForm() {
            if (!confirm('Are you sure you want to clear the form?')) return;

            document.getElementById('screenName').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('streetAddress').value = '';
            document.getElementById('aptSuite').value = '';
            document.getElementById('nearestIntersection').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('zipCode').value = '';
            document.getElementById('trackType').value = '';
            document.getElementById('operatorType').value = '';
            document.getElementById('operatorType').disabled = true;
            document.getElementById('fabricColor').value = '';
            document.getElementById('frameColor').value = '';
            document.getElementById('widthInches').value = '';
            document.getElementById('widthFraction').value = '';
            document.getElementById('heightInches').value = '';
            document.getElementById('heightFraction').value = '';
            document.getElementById('noTracks').checked = false;
            document.getElementById('includeInstallation').checked = true;
            document.getElementById('dimensionsSummary').style.display = 'none';
            document.getElementById('enableComparison').checked = false;
            document.getElementById('comparisonOptions').style.display = 'none';
            document.getElementById('comparisonMotor').value = '';
            document.getElementById('discountLabel').value = '';
            document.getElementById('discountPercent').value = '0';
            updateAccessories();
            editingScreenIndex = null;
        }

        // Multi-screen order functions
        function addToOrder() {
            // Calculate screen data
            const screenData = calculateScreenData();
            if (!screenData) return; // Validation failed

            if (editingScreenIndex !== null) {
                // Update existing screen
                screensInOrder[editingScreenIndex] = screenData;
                editingScreenIndex = null;
            } else {
                // Add new screen
                screensInOrder.push(screenData);
            }

            // Clear form for next screen
            resetFormForNextScreen();

            // Reset button text
            updateAddToOrderButton();

            // Update screen list display
            renderScreensList();

            // Show screens section and hide quote
            document.getElementById('screensInOrder').classList.remove('hidden');
            document.getElementById('quoteSummary').classList.add('hidden');
        }

        function calculateScreenData() {
            // Get form values
            const screenName = document.getElementById('screenName').value.trim();
            const trackType = document.getElementById('trackType').value;
            const operatorType = document.getElementById('operatorType').value;
            const fabricColor = document.getElementById('fabricColor').value;
            const noTracks = document.getElementById('noTracks').checked;
            const includeInstallation = document.getElementById('includeInstallation').checked;

            // Get dimensions
            const widthInches = parseFloat(document.getElementById('widthInches').value) || 0;
            const widthFraction = parseFraction(document.getElementById('widthFraction').value);
            const heightInches = parseFloat(document.getElementById('heightInches').value) || 0;
            const heightFraction = parseFraction(document.getElementById('heightFraction').value);

            // Calculate total inches and round to nearest foot for pricing
            const totalWidthInches = widthInches + widthFraction;
            const totalHeightInches = heightInches + heightFraction;
            const width = Math.round(totalWidthInches / 12);
            const height = Math.round(totalHeightInches / 12);

            // Store actual dimensions for display
            const actualWidthDisplay = inchesToFeetAndInches(totalWidthInches);
            const actualHeightDisplay = inchesToFeetAndInches(totalHeightInches);

            // Validation
            if (!trackType || !operatorType || !fabricColor) {
                alert('Please fill in all required fields (marked with *)');
                return null;
            }

            if (totalWidthInches === 0 || totalHeightInches === 0) {
                alert('Please enter valid screen dimensions');
                return null;
            }

            // Get text labels
            const trackTypeName = document.getElementById('trackType').selectedOptions[0].text;
            const operatorTypeName = document.getElementById('operatorType').selectedOptions[0].text;
            const fabricColorName = document.getElementById('fabricColor').selectedOptions[0].text;

            // Calculate pricing
            const screenType = `${trackType}-${operatorType}`;
            let baseCost = 0;
            let screenCostOnly = 0;
            let priceData = null;
            let motorCost = 0;
            let isFenetex = false;

            if (trackType === 'sunair-zipper') {
                priceData = sunairZipperGear;
            } else if (trackType === 'sunair-cable') {
                priceData = sunairCableGear;
            } else if (trackType === 'fenetex-keder') {
                priceData = fenetexKeder;
                isFenetex = true;
            }

            // Get screen cost from pricing matrix
            if (priceData && priceData[width] && priceData[width][height] !== null && priceData[width][height] !== undefined) {
                let screenCost = priceData[width][height];

                // Apply Sunair discount for non-Fenetex screens
                if (!isFenetex) {
                    screenCost = screenCost * (1 - SUNAIR_DISCOUNT);
                }

                screenCostOnly = screenCost;
                baseCost += screenCost;
            } else {
                alert(`Invalid screen dimensions. No pricing available for ${width}' W x ${height}' H. Please check the size and try again.`);
                return null;
            }

            // Add motor cost for motorized options
            if (operatorType === 'gaposa-rts') {
                motorCost = motorCosts['gaposa-rts'];
            } else if (operatorType === 'gaposa-solar') {
                motorCost = motorCosts['gaposa-solar'];
            } else if (operatorType === 'somfy-rts') {
                motorCost = motorCosts['somfy-rts'];
            }

            // For Fenetex, RTS motor is already included in pricing
            if (!isFenetex && motorCost > 0) {
                baseCost += motorCost;
            }

            // Apply track deduction if selected
            let trackDeduction = 0;
            if (noTracks && trackDeductions[height]) {
                trackDeduction = trackDeductions[height] * (1 - SUNAIR_DISCOUNT);
                baseCost += trackDeduction;
            }

            // Calculate accessories cost
            let accessoriesCost = 0;
            const accessories = [];
            const checkboxes = document.querySelectorAll('.accessory-item input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const accName = cb.dataset.name;
                let accCost = parseFloat(cb.dataset.cost);
                const needsDiscount = cb.dataset.markup === 'true';
                if (needsDiscount) {
                    accCost = accCost * (1 - SUNAIR_DISCOUNT);
                }
                accessoriesCost += accCost;
                accessories.push({
                    name: accName,
                    cost: accCost,
                    needsMarkup: needsDiscount
                });
            });

            let totalCost = baseCost + accessoriesCost;

            // Apply markup to get customer price
            let customerPrice = 0;
            if (isFenetex) {
                // For Fenetex, use Sunair Zipper RTS price for that size + 20%
                const sunairScreenCost = sunairZipperGear[width] && sunairZipperGear[width][height]
                    ? sunairZipperGear[width][height] * (1 - SUNAIR_DISCOUNT)
                    : 0;
                const sunairRTSMotor = motorCosts['gaposa-rts'];

                // Apply markup: (screen * 1.8 + motor * 1.8) * 1.2
                customerPrice = (sunairScreenCost + sunairRTSMotor) * CUSTOMER_MARKUP * FENETEX_MARKUP;

                // Add accessories with their proper markup
                accessories.forEach(acc => {
                    if (acc.needsMarkup) {
                        customerPrice += acc.cost * CUSTOMER_MARKUP;
                    } else {
                        customerPrice += acc.cost;
                    }
                });
            } else {
                // Standard Sunair pricing - separate screen and motor markup
                let screenOnlyCost = baseCost - motorCost;

                // Handle track deduction
                if (noTracks) {
                    screenOnlyCost -= trackDeduction;
                }

                // Apply 1.8x markup to screen
                customerPrice = screenOnlyCost * CUSTOMER_MARKUP;

                // Add motor with 1.8x markup
                customerPrice += motorCost * CUSTOMER_MARKUP;

                // Add back track deduction (negative value) after markup
                if (noTracks) {
                    customerPrice += trackDeduction;
                }

                // Add accessories with their proper markup
                accessories.forEach(acc => {
                    if (acc.needsMarkup) {
                        customerPrice += acc.cost * CUSTOMER_MARKUP;
                    } else {
                        customerPrice += acc.cost;
                    }
                });
            }

            // Calculate installation
            let installationCost = 0;
            let installationPrice = 0;
            if (includeInstallation) {
                const isLarge = width >= 12;
                const isSolar = operatorType === 'gaposa-solar';

                if (isLarge) {
                    installationPrice = isSolar ? installationPricing['solar-large'] : installationPricing['rts-large'];
                } else {
                    installationPrice = isSolar ? installationPricing['solar-small'] : installationPricing['rts-small'];
                }

                installationCost = installationPrice * 0.7;
                customerPrice += installationPrice;
            }

            return {
                screenName: screenName || null,
                trackType,
                trackTypeName,
                operatorType,
                operatorTypeName,
                fabricColor,
                fabricColorName,
                width,
                height,
                actualWidthDisplay,
                actualHeightDisplay,
                noTracks,
                includeInstallation,
                screenCostOnly,
                motorCost,
                baseCost,
                accessories,
                accessoriesCost,
                totalCost,
                installationCost,
                installationPrice,
                customerPrice,
                isFenetex,
                trackDeduction
            };
        }

        function resetFormForNextScreen() {
            document.getElementById('screenName').value = '';
            document.getElementById('trackType').value = '';
            document.getElementById('operatorType').value = '';
            document.getElementById('operatorType').disabled = true;
            document.getElementById('fabricColor').value = '';
            document.getElementById('frameColor').value = '';
            document.getElementById('widthInches').value = '';
            document.getElementById('widthFraction').value = '';
            document.getElementById('heightInches').value = '';
            document.getElementById('heightFraction').value = '';
            document.getElementById('noTracks').checked = false;
            document.getElementById('includeInstallation').checked = true;
            document.getElementById('dimensionsSummary').style.display = 'none';
            updateAccessories();
        }

        function renderScreensList() {
            const screensList = document.getElementById('screensList');
            const screenCount = document.getElementById('screenCount');

            screenCount.textContent = screensInOrder.length;

            if (screensInOrder.length === 0) {
                screensList.innerHTML = '<p>No screens added yet.</p>';
                return;
            }

            let html = '';
            screensInOrder.forEach((screen, index) => {
                const displayName = screen.screenName || `Screen ${index + 1}`;
                const clientTrackName = getClientFacingTrackName(screen.trackTypeName);
                const clientMotorName = getClientFacingOperatorName(screen.operatorType, screen.operatorTypeName);
                const accessoriesText = screen.accessories.length > 0
                    ? screen.accessories.map(a => a.name).join(', ')
                    : 'None';
                const isEditing = editingScreenIndex === index;

                html += `
                    <div class="screen-card ${isEditing ? 'editing' : ''}">
                        <div class="screen-card-header">
                            <h4>${displayName}${isEditing ? ' <span style="color: #007bff;">(Editing...)</span>' : ''}</h4>
                            <div class="screen-card-actions">
                                <button class="btn-edit" onclick="editScreen(${index})">${isEditing ? 'Editing â†‘' : 'Edit'}</button>
                                <button class="btn-duplicate" onclick="duplicateScreen(${index})">Duplicate</button>
                                <button class="btn-remove" onclick="removeScreen(${index})">Remove</button>
                            </div>
                        </div>
                        <div class="screen-card-details">
                            <strong>Track:</strong> ${clientTrackName} |
                            <strong>Motor:</strong> ${clientMotorName}<br>
                            <strong>Size:</strong> ${screen.actualWidthDisplay} W x ${screen.actualHeightDisplay} H |
                            <strong>Fabric:</strong> ${screen.fabricColorName} |
                            <strong>Frame:</strong> ${screen.frameColorName || 'Not specified'}<br>
                            ${screen.noTracks ? '<strong>Configuration:</strong> No Tracks<br>' : ''}
                            <strong>Accessories:</strong> ${accessoriesText}<br>
                            ${screen.includeInstallation ? '<strong>Installation:</strong> Included<br>' : ''}
                            <strong>Price:</strong> ${formatCurrency(screen.customerPrice)}
                        </div>
                    </div>
                `;
            });

            screensList.innerHTML = html;
        }

        function editScreen(index) {
            const screen = screensInOrder[index];
            editingScreenIndex = index;

            // Populate form with screen data
            document.getElementById('screenName').value = screen.screenName || '';
            document.getElementById('trackType').value = screen.trackType;
            document.getElementById('operatorType').value = screen.operatorType;
            document.getElementById('fabricColor').value = screen.fabricColor;
            document.getElementById('noTracks').checked = screen.noTracks;
            document.getElementById('includeInstallation').checked = screen.includeInstallation;

            // Set dimensions - need to calculate back from display
            // For simplicity, we'll use the pricing dimensions
            document.getElementById('widthInches').value = screen.width * 12;
            document.getElementById('widthFraction').value = '';
            document.getElementById('heightInches').value = screen.height * 12;
            document.getElementById('heightFraction').value = '';

            // Trigger track type change to populate operator dropdown
            const trackTypeSelect = document.getElementById('trackType');
            trackTypeSelect.dispatchEvent(new Event('change'));

            // Set operator type after dropdown is populated, then check accessories
            setTimeout(() => {
                document.getElementById('operatorType').value = screen.operatorType;
                // Update accessories after operator is set
                updateAccessories();

                // Check the accessories that were selected - wait for accessories to render
                setTimeout(() => {
                    screen.accessories.forEach(acc => {
                        const checkboxes = document.querySelectorAll('.accessory-item input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            if (cb.dataset.name === acc.name) {
                                cb.checked = true;
                            }
                        });
                    });
                }, 50);
            }, 10);

            // Update button text to show we're editing
            updateAddToOrderButton();

            // Update the screen card display to show editing state
            renderScreensList();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Show alert
            alert(`Editing "${displayName}". Make your changes above and click "Update Screen" to save.`);
        }

        function updateAddToOrderButton() {
            const btn = document.getElementById('addToOrderBtn');
            if (!btn) return;

            if (editingScreenIndex !== null) {
                btn.textContent = 'Update Screen';
                btn.style.background = '#28a745';
            } else {
                btn.textContent = 'Add to Order';
                btn.style.background = '';
            }
        }

        function duplicateScreen(index) {
            const screen = JSON.parse(JSON.stringify(screensInOrder[index])); // Deep copy
            screen.screenName = screen.screenName ? `${screen.screenName} (Copy)` : null;
            screensInOrder.push(screen);
            renderScreensList();
        }

        function removeScreen(index) {
            if (!confirm('Are you sure you want to remove this screen?')) return;
            screensInOrder.splice(index, 1);
            renderScreensList();

            if (screensInOrder.length === 0) {
                document.getElementById('screensInOrder').classList.add('hidden');
                document.getElementById('quoteSummary').classList.add('hidden');
            }
        }

        function calculateOrderQuote() {
            if (screensInOrder.length === 0) {
                alert('Please add at least one screen to the order');
                return;
            }

            // Get customer info
            const customerName = document.getElementById('customerName').value;
            if (!customerName) {
                alert('Please enter customer name');
                return;
            }

            // Calculate totals
            let orderTotalCost = 0;
            let orderTotalMaterialsPrice = 0;
            let orderTotalInstallationCost = 0;
            let orderTotalInstallationPrice = 0;
            let hasCableScreen = false;

            // Internal cost breakdowns
            let totalScreenCosts = 0;
            let totalMotorCosts = 0;
            let totalAccessoriesCosts = 0;
            let totalCableSurcharge = 0;

            screensInOrder.forEach((screen, index) => {
                // Materials price (excluding installation)
                let screenMaterialsPrice = screen.customerPrice - screen.installationPrice;

                // Check if this is a cable screen and apply surcharge only to first
                let screenCost = screen.totalCost;

                if (screen.trackType === 'sunair-cable') {
                    if (!hasCableScreen) {
                        // First cable screen - add surcharge
                        screenCost += CABLE_SURCHARGE;
                        screenMaterialsPrice += CABLE_SURCHARGE * CUSTOMER_MARKUP;
                        totalCableSurcharge += CABLE_SURCHARGE;
                        hasCableScreen = true;
                    }
                }

                orderTotalCost += screenCost;
                orderTotalMaterialsPrice += screenMaterialsPrice;
                orderTotalInstallationCost += screen.installationCost;
                orderTotalInstallationPrice += screen.installationPrice;

                // Track internal cost breakdowns
                totalScreenCosts += screen.screenCostOnly;
                totalMotorCosts += screen.motorCost;
                totalAccessoriesCosts += screen.accessoriesCost;
            });

            // Get discount information
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountLabel = document.getElementById('discountLabel').value.trim() || 'Discount';
            const discountAmount = (orderTotalMaterialsPrice * discountPercent) / 100;
            const discountedMaterialsPrice = orderTotalMaterialsPrice - discountAmount;

            const orderTotalPrice = discountedMaterialsPrice + orderTotalInstallationPrice;
            const totalProfit = orderTotalPrice - orderTotalCost - orderTotalInstallationCost;
            const marginPercent = orderTotalPrice > 0 ? (totalProfit / orderTotalPrice) * 100 : 0;

            // Get comparison information
            const enableComparison = document.getElementById('enableComparison').checked;
            const comparisonMotor = document.getElementById('comparisonMotor').value;

            // Calculate comparison totals if enabled
            let comparisonTotalMaterialsPrice = 0;
            let comparisonTotalPrice = 0;
            let comparisonDiscountedMaterialsPrice = 0;
            const comparisonScreens = [];

            if (enableComparison && comparisonMotor) {
                screensInOrder.forEach(screen => {
                    // Only compare motorized screens
                    if (screen.operatorType !== 'gear') {
                        const comparisonData = calculateScreenWithAlternateMotor(screen, comparisonMotor);
                        comparisonScreens.push({
                            ...screen,
                            comparisonPrice: comparisonData.customerPrice,
                            comparisonMaterialPrice: comparisonData.materialPrice
                        });
                        comparisonTotalMaterialsPrice += comparisonData.materialPrice;
                    } else {
                        comparisonScreens.push({
                            ...screen,
                            comparisonPrice: screen.customerPrice,
                            comparisonMaterialPrice: screen.customerPrice - screen.installationPrice
                        });
                        comparisonTotalMaterialsPrice += (screen.customerPrice - screen.installationPrice);
                    }
                });

                // Apply discount to comparison totals
                const comparisonDiscountAmount = (comparisonTotalMaterialsPrice * discountPercent) / 100;
                comparisonDiscountedMaterialsPrice = comparisonTotalMaterialsPrice - comparisonDiscountAmount;
                comparisonTotalPrice = comparisonDiscountedMaterialsPrice + orderTotalInstallationPrice;
            }

            // Display order quote summary
            displayOrderQuoteSummary({
                customerName,
                screens: enableComparison && comparisonMotor ? comparisonScreens : screensInOrder,
                orderTotalCost,
                orderTotalMaterialsPrice,
                orderTotalInstallationPrice,
                orderTotalPrice,
                orderTotalInstallationCost,
                totalProfit,
                marginPercent,
                hasCableScreen,
                totalScreenCosts,
                totalMotorCosts,
                totalAccessoriesCosts,
                totalCableSurcharge,
                discountPercent,
                discountLabel,
                discountAmount,
                discountedMaterialsPrice,
                enableComparison,
                comparisonMotor,
                comparisonTotalMaterialsPrice,
                comparisonDiscountedMaterialsPrice,
                comparisonTotalPrice
            });
        }

        function displayOrderQuoteSummary(orderData) {
            // Store order data globally for finalize page access
            window.currentOrderData = orderData;

            const summaryContent = document.getElementById('summaryContent');
            const internalInfo = document.getElementById('internalInfo');
            const quoteSummary = document.getElementById('quoteSummary');

            // Get motor names for comparison if enabled
            let comparisonMotorName = '';
            let clientMotorName = '';
            if (orderData.enableComparison && orderData.comparisonMotor && orderData.screens.length > 0) {
                comparisonMotorName = getClientFacingOperatorName(orderData.comparisonMotor, '');
                // Get the first screen's motor name for the header
                const firstMotorizedScreen = orderData.screens.find(s => s.operatorType !== 'gear');
                if (firstMotorizedScreen) {
                    clientMotorName = getClientFacingOperatorName(firstMotorizedScreen.operatorType, firstMotorizedScreen.operatorTypeName);
                }
            }

            // Build address display
            let addressParts = [];
            if (orderData.streetAddress) addressParts.push(orderData.streetAddress);
            if (orderData.aptSuite) addressParts.push(orderData.aptSuite);
            const addressLine1 = addressParts.join(', ');

            let cityStateZip = [];
            if (orderData.city) cityStateZip.push(orderData.city);
            if (orderData.state) cityStateZip.push(orderData.state);
            let addressLine2 = cityStateZip.join(', ');
            if (orderData.zipCode) addressLine2 = addressLine2 ? addressLine2 + ' ' + orderData.zipCode : orderData.zipCode;

            const fullAddress = [addressLine1, addressLine2].filter(x => x).join('<br>');

            // Customer-facing summary
            let customerHTML = `
                <div class="summary-row">
                    <strong>Customer:</strong>
                    <span>${orderData.customerName}${orderData.companyName ? ' (' + orderData.companyName + ')' : ''}</span>
                </div>
                ${fullAddress ? `<div class="summary-row">
                    <strong>Project Address:</strong>
                    <span>${fullAddress}</span>
                </div>` : ''}
                ${orderData.nearestIntersection ? `<div class="summary-row">
                    <strong>Nearest Intersection:</strong>
                    <span>${orderData.nearestIntersection}</span>
                </div>` : ''}
                <div class="summary-row" style="border-bottom: 2px solid #0056A3; padding-bottom: 10px; margin-bottom: 10px;">
                    <strong>Total Screens:</strong>
                    <span>${orderData.screens.length}</span>
                </div>
            `;

            // Add each screen details
            orderData.screens.forEach((screen, index) => {
                const displayName = screen.screenName || `Screen ${index + 1}`;
                const screenMaterialsPrice = screen.customerPrice - screen.installationPrice;
                const clientTrackName = getClientFacingTrackName(screen.trackTypeName);
                const clientMotorName = getClientFacingOperatorName(screen.operatorType, screen.operatorTypeName);

                customerHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #0056A3; padding-bottom: 8px; margin-bottom: 8px;">
                            <strong style="flex: 1;">${displayName}</strong>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                ${orderData.enableComparison && orderData.comparisonMotor ? `
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">${clientMotorName}</div>
                                        <strong>${formatCurrency(screenMaterialsPrice)}</strong>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 2px;">${comparisonMotorName}</div>
                                        <strong style="color: #007bff;">${formatCurrency(screen.comparisonMaterialPrice || screenMaterialsPrice)}</strong>
                                    </div>
                                ` : `
                                    <strong>${formatCurrency(screenMaterialsPrice)}</strong>
                                `}
                            </div>
                        </div>
                        <div class="summary-row">
                            <span>Track System:</span>
                            <span>${clientTrackName}</span>
                        </div>
                        <div class="summary-row">
                            <span>Operator:</span>
                            <span>${clientMotorName}</span>
                        </div>
                        <div class="summary-row">
                            <span>Fabric:</span>
                            <span>${screen.fabricColorName}</span>
                        </div>
                        <div class="summary-row">
                            <span>Frame:</span>
                            <span>${screen.frameColorName || 'Not specified'}</span>
                        </div>
                        <div class="summary-row">
                            <span>Dimensions:</span>
                            <span>${screen.actualWidthDisplay} W x ${screen.actualHeightDisplay} H</span>
                        </div>
                        ${screen.noTracks ? '<div class="summary-row"><span>Configuration:</span><span>No Tracks</span></div>' : ''}
                        ${screen.accessories.length > 0 ? `<div class="summary-row"><span>Accessories:</span><span>${screen.accessories.map(a => a.name).join(', ')}</span></div>` : ''}
                    </div>
                `;
            });

            // Add subtotal, discount, installation, and grand total
            if (orderData.enableComparison && orderData.comparisonMotor) {
                // Show comparison columns
                customerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.05rem; border-top: 2px solid #0056A3; padding-top: 10px; margin-bottom: 8px;">
                        <strong>Materials Subtotal:</strong>
                        <div style="display: flex; gap: 20px;">
                            <div style="min-width: 120px; text-align: right;">
                                <div style="font-size: 0.75rem; color: #666; font-weight: normal; margin-bottom: 2px;">${clientMotorName}</div>
                                <strong>${formatCurrency(orderData.orderTotalMaterialsPrice)}</strong>
                            </div>
                            <div style="min-width: 120px; text-align: right;">
                                <div style="font-size: 0.75rem; color: #666; font-weight: normal; margin-bottom: 2px;">${comparisonMotorName}</div>
                                <strong style="color: #007bff;">${formatCurrency(orderData.comparisonTotalMaterialsPrice)}</strong>
                            </div>
                        </div>
                    </div>
                `;

                if (orderData.discountAmount > 0) {
                    const comparisonDiscountAmount = (orderData.comparisonTotalMaterialsPrice * orderData.discountPercent) / 100;
                    customerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; color: #28a745; margin-bottom: 8px;">
                            <strong>${orderData.discountLabel} (${orderData.discountPercent}%):</strong>
                            <div style="display: flex; gap: 20px;">
                                <strong style="min-width: 120px; text-align: right;">-${formatCurrency(orderData.discountAmount)}</strong>
                                <strong style="min-width: 120px; text-align: right; color: #007bff;">-${formatCurrency(comparisonDiscountAmount)}</strong>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 8px;">
                            <strong>Discounted Materials Total:</strong>
                            <div style="display: flex; gap: 20px;">
                                <strong style="min-width: 120px; text-align: right;">${formatCurrency(orderData.discountedMaterialsPrice)}</strong>
                                <strong style="min-width: 120px; text-align: right; color: #007bff;">${formatCurrency(orderData.comparisonDiscountedMaterialsPrice)}</strong>
                            </div>
                        </div>
                    `;
                }

                if (orderData.orderTotalInstallationPrice > 0) {
                    customerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong>Installation:</strong>
                            <div style="display: flex; gap: 20px;">
                                <strong style="min-width: 120px; text-align: right;">${formatCurrency(orderData.orderTotalInstallationPrice)}</strong>
                                <strong style="min-width: 120px; text-align: right; color: #007bff;">${formatCurrency(orderData.orderTotalInstallationPrice)}</strong>
                            </div>
                        </div>
                    `;
                }

                customerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; font-weight: bold; color: #0056A3; margin-top: 8px; padding-top: 12px; border-top: 2px solid #0056A3;">
                        <strong>Grand Total:</strong>
                        <div style="display: flex; gap: 20px;">
                            <strong style="min-width: 120px; text-align: right;">${formatCurrency(orderData.orderTotalPrice)}</strong>
                            <strong style="min-width: 120px; text-align: right; color: #007bff;">${formatCurrency(orderData.comparisonTotalPrice)}</strong>
                        </div>
                    </div>
                `;
            } else {
                // Standard single-column display
                customerHTML += `
                    <div class="summary-row" style="font-weight: bold; font-size: 1.05rem; border-top: 2px solid #0056A3; padding-top: 10px;">
                        <strong>Materials Subtotal:</strong>
                        <strong>${formatCurrency(orderData.orderTotalMaterialsPrice)}</strong>
                    </div>
                `;

                if (orderData.discountAmount > 0) {
                    customerHTML += `
                        <div class="summary-row" style="color: #28a745;">
                            <strong>${orderData.discountLabel} (${orderData.discountPercent}%):</strong>
                            <strong>-${formatCurrency(orderData.discountAmount)}</strong>
                        </div>
                        <div class="summary-row" style="font-weight: bold;">
                            <strong>Discounted Materials Total:</strong>
                            <strong>${formatCurrency(orderData.discountedMaterialsPrice)}</strong>
                        </div>
                    `;
                }

                if (orderData.orderTotalInstallationPrice > 0) {
                    customerHTML += `
                        <div class="summary-row">
                            <strong>Installation:</strong>
                            <strong>${formatCurrency(orderData.orderTotalInstallationPrice)}</strong>
                        </div>
                    `;
                }

                customerHTML += `
                    <div class="summary-row total">
                        <strong>Grand Total:</strong>
                        <strong>${formatCurrency(orderData.orderTotalPrice)}</strong>
                    </div>
                `;
            }

            summaryContent.innerHTML = customerHTML;

            // Internal information
            let internalHTML = `
                <h4 style="margin-bottom: 10px;">Cost Breakdown (Internal)</h4>
                <div class="summary-row">
                    <strong>Total Screen Costs:</strong>
                    <span>${formatCurrency(orderData.totalScreenCosts)}</span>
                </div>
                <div class="summary-row">
                    <strong>Total Motor Costs:</strong>
                    <span>${formatCurrency(orderData.totalMotorCosts)}</span>
                </div>
                <div class="summary-row">
                    <strong>Total Accessories Costs:</strong>
                    <span>${formatCurrency(orderData.totalAccessoriesCosts)}</span>
                </div>
            `;

            if (orderData.totalCableSurcharge > 0) {
                internalHTML += `
                    <div class="summary-row">
                        <strong>Cable Surcharge:</strong>
                        <span>${formatCurrency(orderData.totalCableSurcharge)}</span>
                    </div>
                `;
            }

            internalHTML += `
                <div class="summary-row" style="border-top: 1px solid #856404; padding-top: 8px; margin-top: 8px;">
                    <strong>Total Materials Cost:</strong>
                    <span>${formatCurrency(orderData.orderTotalCost)}</span>
                </div>
                <div class="summary-row">
                    <strong>Installation Cost (70% to installer):</strong>
                    <span>${formatCurrency(orderData.orderTotalInstallationCost)}</span>
                </div>
                <div class="summary-row" style="border-top: 2px solid #856404; padding-top: 8px; margin-top: 8px;">
                    <strong>Total Profit:</strong>
                    <span style="color: #28a745; font-weight: bold;">${formatCurrency(orderData.totalProfit)}</span>
                </div>
                <div class="summary-row">
                    <strong>Margin:</strong>
                    <span style="color: #28a745; font-weight: bold;">${orderData.marginPercent.toFixed(1)}%</span>
                </div>
            `;

            internalInfo.innerHTML = internalHTML;
            quoteSummary.classList.remove('hidden');

            // Scroll to quote
            quoteSummary.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalize Project Details - Roll-A-Shield</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="nav-steps.css">
    <style>
        .project-info {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .project-info h3 {
            color: #0056A3;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .screen-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .screen-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .screen-card:hover {
            border-color: #0056A3;
            box-shadow: 0 2px 8px rgba(0, 86, 163, 0.2);
        }

        .screen-card.active {
            border-color: #0056A3;
            background: #f0f7ff;
        }

        .screen-card.completed {
            border-color: #28a745;
            background: #f0fff4;
        }

        .screen-card h4 {
            color: #0056A3;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .screen-card .status {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }

        .screen-card.completed .status {
            color: #28a745;
            font-weight: 600;
        }

        .measurement-form {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            display: none;
        }

        .measurement-form.active {
            display: block;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .form-section h3 {
            color: #0056A3;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 2px solid #0056A3;
            padding-bottom: 8px;
        }

        .measurement-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .measurement-input {
            flex: 1;
        }

        .checkmark-indicator {
            color: #28a745;
            font-size: 1.2rem;
            font-weight: bold;
            visibility: hidden;
            margin-left: 5px;
        }

        .checkmark-indicator.selected {
            visibility: visible;
        }

        .quote-reference {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .quote-reference strong {
            color: #856404;
        }

        .checkbox-group {
            margin-bottom: 10px;
        }

        .save-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px;
        }

        .save-button:hover {
            background: #218838;
        }

        .complete-button {
            background: #0056A3;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 30px;
            display: block;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .complete-button:hover {
            background: #003D7A;
        }

        .complete-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }

        /* Photo sections */
        .photo-grid-finalize {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        .photo-grid-finalize .photo-thumb {
            position: relative;
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
            background: #eee;
        }
        .photo-grid-finalize .photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        .photo-grid-finalize .photo-thumb .photo-remove {
            position: absolute;
            top: 3px;
            right: 3px;
            width: 22px;
            height: 22px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 13px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            padding: 0;
        }
        .photo-grid-finalize .photo-thumb .photo-remove:hover {
            background: rgba(200,0,0,0.8);
        }

        /* ─── Mobile Responsive ─── */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .measurement-form { padding: 12px !important; }
            .form-section { padding: 12px; }
            .screen-card { padding: 10px; }
            .complete-button { font-size: 14px; padding: 12px; }
        }

        @media (max-width: 480px) {
            .container { padding: 6px; }
            .measurement-form { padding: 8px !important; }
            .form-section { padding: 10px; }
            h2 { font-size: 1.1rem; }
            .form-section h3 { font-size: 0.95rem; }
            /* Stack measurement groups vertically on small screens */
            .measurement-group {
                flex-direction: column;
                gap: 6px;
                align-items: stretch;
            }
            .measurement-group .measurement-input {
                width: 100%;
            }
            /* Fraction inputs: shrink from 80px to 60px */
            .fraction-input {
                flex: 0 0 60px !important;
                font-size: 0.8rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Finalize Project Details</h1>
            <p>Final Measurements & Production Details</p>
        </div>

        <div id="stepNav"></div>

        <div class="content">
            <!-- Project Info -->
            <div class="project-info" id="projectInfo">
                <h3>Project Information</h3>
                <div id="projectDetails">Loading...</div>
            </div>

            <!-- Screen Selection -->
            <h2 style="color: #0056A3; margin-bottom: 15px;">Select Screen to Finalize:</h2>
            <div class="screen-list" id="screenList">
                <!-- Screen cards will be populated here -->
            </div>

            <!-- Measurement Form -->
            <div class="measurement-form" id="measurementForm">
                <!-- Form will be populated dynamically -->
            </div>

            <!-- Difficult Install Flag -->
            <div class="form-section" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; color: #856404;">
                    <input type="checkbox" id="difficultInstall">
                    Difficult Install – Recommend installer visit for remeasure / installation prep
                </label>
            </div>

            <!-- Production Comments -->
            <div class="form-section">
                <h3>Production Comments</h3>
                <textarea id="productionComments" rows="4" style="width: 100%;" placeholder="Any additional notes for the production team..."></textarea>
            </div>

            <!-- Complete Button -->
            <button class="complete-button" id="completeButton" disabled>Generate Production Email</button>
        </div>
    </div>

    <script src="nav-steps.js"></script>
    <script>
        // Configuration
        const WORKER_URL = 'https://rollashield-quote-worker.derek-44b.workers.dev';

        // Load order data from D1 cloud database
        let orderData = null;
        let finalMeasurements = {};
        let currentScreenIndex = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await loadOrderData();
            if (!orderData) return; // loadOrderData handles redirect
            checkSignatureStatus();
            loadSavedMeasurements();
            displayProjectInfo();
            displayScreenList();
        });

        function checkSignatureStatus() {
            // Show warning if quote hasn't been signed yet
            if (!orderData.quote_status || orderData.quote_status !== 'signed') {
                const container = document.querySelector('.container') || document.body;
                const warning = document.createElement('div');
                warning.className = 'unsigned-warning';
                warning.innerHTML = '<p>This quote has not been signed by the customer yet. You may still proceed with finalization.</p><button class="dismiss-btn" onclick="this.parentElement.remove()">&times;</button>';
                container.insertBefore(warning, container.firstChild);
            }
        }

        async function loadOrderData() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                alert('No order ID provided. Returning to quote page.');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${WORKER_URL}/api/quote/${orderId}`);
                const result = await response.json();

                if (response.ok && result.success && result.quote) {
                    orderData = result.quote;
                } else {
                    alert('Order not found. Returning to quote page.');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error loading order data:', error);
                alert('Failed to load order data. Please check your internet connection.\n\nError: ' + error.message);
                window.location.href = 'index.html';
            }
        }

        function loadSavedMeasurements() {
            // Measurements are stored within the order data from D1
            if (orderData && orderData.measurements) {
                finalMeasurements = orderData.measurements;
            }
        }

        // ─── Photo helpers (finalize) ────────────────────────────────────────

        function compressPhotoFinalize(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    const maxDim = 2048;
                    let w = img.width, h = img.height;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                        else { w = Math.round(w * maxDim / h); h = maxDim; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error('Compression failed')), 'image/jpeg', 0.75);
                };
                img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Load failed')); };
                img.src = url;
            });
        }

        async function handleInstallationPhotoSelect(event, screenIndex) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;

            const screen = orderData.screens[screenIndex];
            if (!screen.photos) screen.photos = [];
            const currentInstall = screen.photos.filter(p => p.category === 'installation').length;
            const remaining = 5 - currentInstall;

            if (remaining <= 0) {
                alert('Maximum 5 installation photos per screen.');
                event.target.value = '';
                return;
            }

            const toProcess = files.slice(0, remaining);
            if (toProcess.length < files.length) {
                alert(`Only adding ${toProcess.length} of ${files.length} photos (limit: 5).`);
            }

            for (const file of toProcess) {
                try {
                    const compressed = await compressPhotoFinalize(file);
                    const formData = new FormData();
                    formData.append('photo', compressed, file.name || 'photo.jpg');
                    formData.append('quoteId', orderData.id.toString());
                    formData.append('screenIndex', String(screenIndex));

                    const resp = await fetch(`${WORKER_URL}/api/photos/upload`, { method: 'POST', body: formData });
                    const result = await resp.json();
                    if (result.success && result.photo) {
                        screen.photos.push({
                            key: result.photo.key,
                            url: `${WORKER_URL}/r2/${result.photo.key}`,
                            filename: result.photo.filename,
                            size: result.photo.size,
                            contentType: result.photo.contentType,
                            uploadedAt: new Date().toISOString(),
                            category: 'installation'
                        });
                    }
                } catch (err) {
                    console.error('Installation photo upload failed:', err);
                }
            }

            event.target.value = '';
            await saveMeasurements();
            displayMeasurementForm(screenIndex);
        }

        async function removeInstallationPhoto(screenIndex, photoIndexInCategory) {
            const screen = orderData.screens[screenIndex];
            const installPhotos = (screen.photos || []).filter(p => p.category === 'installation');
            const photo = installPhotos[photoIndexInCategory];
            if (!photo) return;

            // Remove from screen.photos array
            const globalIndex = screen.photos.indexOf(photo);
            if (globalIndex !== -1) screen.photos.splice(globalIndex, 1);

            // Delete from R2
            if (photo.key) {
                try {
                    await fetch(`${WORKER_URL}/api/photos/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key: photo.key })
                    });
                } catch (err) {
                    console.error('Failed to delete photo from R2:', err);
                }
            }

            await saveMeasurements();
            displayMeasurementForm(screenIndex);
        }

        async function saveMeasurements() {
            // Embed measurements into the order data and save back to D1
            orderData.measurements = finalMeasurements;

            try {
                const response = await fetch(`${WORKER_URL}/api/save-quote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    console.error('Failed to save measurements:', result.error);
                }
            } catch (error) {
                console.error('Error saving measurements:', error);
            }

            checkAllScreensComplete();
        }

        function displayProjectInfo() {
            const details = document.getElementById('projectDetails');
            details.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div><strong>Customer:</strong> ${orderData.customerName}</div>
                    ${orderData.companyName ? `<div><strong>Company:</strong> ${orderData.companyName}</div>` : ''}
                    <div><strong>Phone:</strong> ${orderData.customerPhone || 'N/A'}</div>
                    <div><strong>Email:</strong> ${orderData.customerEmail || 'N/A'}</div>
                    <div><strong>Total Screens:</strong> ${orderData.screens.length}</div>
                </div>
            `;
        }

        function displayScreenList() {
            const screenList = document.getElementById('screenList');
            screenList.innerHTML = '';

            orderData.screens.forEach((screen, index) => {
                const isComplete = finalMeasurements[index] && finalMeasurements[index].complete;
                const card = document.createElement('div');
                card.className = 'screen-card' + (isComplete ? ' completed' : '');
                card.onclick = () => selectScreen(index);

                card.innerHTML = `
                    <h4>Screen ${index + 1}</h4>
                    <div style="font-size: 0.85rem; color: #666;">
                        ${screen.trackTypeName}<br>
                        ${screen.operatorTypeName}<br>
                        ${screen.actualWidthDisplay} x ${screen.actualHeightDisplay}
                    </div>
                    <div class="status">
                        ${isComplete ? '✓ Measurements Complete' : '○ Pending Measurements'}
                    </div>
                `;

                screenList.appendChild(card);
            });
        }

        function selectScreen(index) {
            currentScreenIndex = index;
            displayMeasurementForm(index);

            // Update active state on cards
            document.querySelectorAll('.screen-card').forEach((card, i) => {
                card.classList.toggle('active', i === index);
            });
        }

        // Store quoted dimensions in inches for comparison with final measurements
        let quotedWidthInches = 0;
        let quotedHeightInches = 0;

        function parseFraction(fractionStr) {
            if (!fractionStr || fractionStr.trim() === '') return 0;
            const parts = fractionStr.trim().split('/');
            if (parts.length === 2) {
                const numerator = parseFloat(parts[0]);
                const denominator = parseFloat(parts[1]);
                if (denominator !== 0 && !isNaN(numerator) && !isNaN(denominator)) {
                    return numerator / denominator;
                }
            }
            return 0;
        }

        function getMeasurement(id) {
            const whole = parseFloat(document.getElementById(id).value) || 0;
            const frac = parseFraction(document.getElementById(id + 'Frac')?.value);
            return whole + frac;
        }

        // Extract whole-inch part for display (strips fraction portion if saved as combined value)
        function wholeInches(saved, key) {
            if (!saved[key]) return '';
            const fracKey = key + 'Frac';
            // If fraction string is stored, subtract it from the combined value to get whole inches
            if (saved[fracKey]) {
                return Math.floor(saved[key]) || '';
            }
            // Legacy data: no fraction stored, show as-is
            return saved[key];
        }

        function displayMeasurementForm(index) {
            const form = document.getElementById('measurementForm');
            const screen = orderData.screens[index];
            const saved = finalMeasurements[index] || {};

            // Store quoted dimensions for validation comparison
            quotedWidthInches = screen.totalWidthInches || 0;
            quotedHeightInches = screen.totalHeightInches || 0;

            form.innerHTML = `
                <h2 style="color: #0056A3; margin-bottom: 15px;">Screen ${index + 1} - Final Measurements</h2>

                <!-- Quote Reference -->
                <div class="quote-reference">
                    <strong>Original Quote Dimensions:</strong> ${screen.actualWidthDisplay} W x ${screen.actualHeightDisplay} H
                </div>

                <!-- Width Measurements -->
                <div class="form-section">
                    <h3>Width Measurements (System will use narrowest)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Top Width *</label>
                            <div class="measurement-group">
                                <div style="display: flex; gap: 6px; align-items: center; flex: 1;">
                                    <input type="number" id="widthTop" class="measurement-input" placeholder="Inches" step="1" value="${wholeInches(saved, 'widthTop')}" required>
                                    <input type="text" id="widthTopFrac" class="fraction-input" placeholder="e.g. 3/8" value="${saved.widthTopFrac || ''}" style="flex: 0 0 80px; padding: 8px 6px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.85rem; text-align: center;">
                                </div>
                                <span class="checkmark-indicator" id="checkWidthTop">✓</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Middle Width *</label>
                            <div class="measurement-group">
                                <div style="display: flex; gap: 6px; align-items: center; flex: 1;">
                                    <input type="number" id="widthMiddle" class="measurement-input" placeholder="Inches" step="1" value="${wholeInches(saved, 'widthMiddle')}" required>
                                    <input type="text" id="widthMiddleFrac" class="fraction-input" placeholder="e.g. 3/8" value="${saved.widthMiddleFrac || ''}" style="flex: 0 0 80px; padding: 8px 6px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.85rem; text-align: center;">
                                </div>
                                <span class="checkmark-indicator" id="checkWidthMiddle">✓</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Bottom Width *</label>
                            <div class="measurement-group">
                                <div style="display: flex; gap: 6px; align-items: center; flex: 1;">
                                    <input type="number" id="widthBottom" class="measurement-input" placeholder="Inches" step="1" value="${wholeInches(saved, 'widthBottom')}" required>
                                    <input type="text" id="widthBottomFrac" class="fraction-input" placeholder="e.g. 3/8" value="${saved.widthBottomFrac || ''}" style="flex: 0 0 80px; padding: 8px 6px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.85rem; text-align: center;">
                                </div>
                                <span class="checkmark-indicator" id="checkWidthBottom">✓</span>
                            </div>
                        </div>
                    </div>
                    <div id="widthSpreadWarning" style="display: none; color: #b45309; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px 12px; margin-top: 8px; font-size: 0.85rem; font-weight: 500;">
                        Width measurements differ by more than 2". Double-check your entry.
                    </div>
                    <div id="widthQuoteWarning" style="display: none; color: #b45309; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px 12px; margin-top: 8px; font-size: 0.85rem; font-weight: 500;">
                    </div>
                </div>

                <!-- Height Measurements -->
                <div class="form-section">
                    <h3>Height Measurements (System will use tallest)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Left Height *</label>
                            <div class="measurement-group">
                                <div style="display: flex; gap: 6px; align-items: center; flex: 1;">
                                    <input type="number" id="heightLeft" class="measurement-input" placeholder="Inches" step="1" value="${wholeInches(saved, 'heightLeft')}" required>
                                    <input type="text" id="heightLeftFrac" class="fraction-input" placeholder="e.g. 3/8" value="${saved.heightLeftFrac || ''}" style="flex: 0 0 80px; padding: 8px 6px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.85rem; text-align: center;">
                                </div>
                                <span class="checkmark-indicator" id="checkHeightLeft">✓</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Middle Height *</label>
                            <div class="measurement-group">
                                <div style="display: flex; gap: 6px; align-items: center; flex: 1;">
                                    <input type="number" id="heightMiddle" class="measurement-input" placeholder="Inches" step="1" value="${wholeInches(saved, 'heightMiddle')}" required>
                                    <input type="text" id="heightMiddleFrac" class="fraction-input" placeholder="e.g. 3/8" value="${saved.heightMiddleFrac || ''}" style="flex: 0 0 80px; padding: 8px 6px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.85rem; text-align: center;">
                                </div>
                                <span class="checkmark-indicator" id="checkHeightMiddle">✓</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Right Height *</label>
                            <div class="measurement-group">
                                <div style="display: flex; gap: 6px; align-items: center; flex: 1;">
                                    <input type="number" id="heightRight" class="measurement-input" placeholder="Inches" step="1" value="${wholeInches(saved, 'heightRight')}" required>
                                    <input type="text" id="heightRightFrac" class="fraction-input" placeholder="e.g. 3/8" value="${saved.heightRightFrac || ''}" style="flex: 0 0 80px; padding: 8px 6px; border: 2px solid #ddd; border-radius: 4px; font-size: 0.85rem; text-align: center;">
                                </div>
                                <span class="checkmark-indicator" id="checkHeightRight">✓</span>
                            </div>
                        </div>
                    </div>
                    <div id="heightSpreadWarning" style="display: none; color: #b45309; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px 12px; margin-top: 8px; font-size: 0.85rem; font-weight: 500;">
                        Height measurements differ by more than 2". Double-check your entry.
                    </div>
                    <div id="heightQuoteWarning" style="display: none; color: #b45309; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px 12px; margin-top: 8px; font-size: 0.85rem; font-weight: 500;">
                    </div>
                </div>

                <!-- Basic Details -->
                <div class="form-section">
                    <h3>Installation Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Operator Side *</label>
                            <select id="operatorSide" required>
                                <option value="">-- Select Side --</option>
                                <option value="left" ${saved.operatorSide === 'left' ? 'selected' : ''}>Left</option>
                                <option value="right" ${saved.operatorSide === 'right' ? 'selected' : ''}>Right</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mount Type *</label>
                            <select id="mountType" required>
                                <option value="wall" ${!saved.mountType || saved.mountType === 'wall' ? 'selected' : ''}>Wall Mount</option>
                                <option value="ceiling" ${saved.mountType === 'ceiling' ? 'selected' : ''}>Ceiling Mount</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Hem Bar Brush Size * <span id="brushSlopeWarning" style="color: red; font-weight: bold; font-size: 0.85em; display: none;">Increased Automatically Due to Slope</span></label>
                            <select id="hemBarBrush" required>
                                <option value="0.5" ${!saved.hemBarBrush || saved.hemBarBrush === '0.5' ? 'selected' : ''}>0.5"</option>
                                <option value="1" ${saved.hemBarBrush === '1' ? 'selected' : ''}>1"</option>
                                <option value="1.5" ${saved.hemBarBrush === '1.5' ? 'selected' : ''}>1.5"</option>
                                <option value="pvc" ${saved.hemBarBrush === 'pvc' ? 'selected' : ''}>PVC Gasket</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Surface Material *</label>
                            <select id="surfaceMaterial" required>
                                <option value="">-- Select Material --</option>
                                <option value="brick" ${saved.surfaceMaterial === 'brick' ? 'selected' : ''}>Brick</option>
                                <option value="block" ${saved.surfaceMaterial === 'block' ? 'selected' : ''}>Block</option>
                                <option value="concrete" ${saved.surfaceMaterial === 'concrete' ? 'selected' : ''}>Concrete</option>
                                <option value="stone" ${saved.surfaceMaterial === 'stone' ? 'selected' : ''}>Stone</option>
                                <option value="stucco" ${saved.surfaceMaterial === 'stucco' ? 'selected' : ''}>Stucco</option>
                                <option value="wood" ${saved.surfaceMaterial === 'wood' ? 'selected' : ''}>Wood/Siding</option>
                                <option value="steel" ${saved.surfaceMaterial === 'steel' ? 'selected' : ''}>Steel</option>
                                <option value="aluminum" ${saved.surfaceMaterial === 'aluminum' ? 'selected' : ''}>Aluminum</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Conditional Fields for Gear Operation -->
                <div class="form-section ${screen.operatorType === 'gear' ? '' : 'hidden'}" id="gearFields">
                    <h3>Gear Operation Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Length of Crank *</label>
                            <select id="crankLength">
                                <option value="57" ${!saved.crankLength || saved.crankLength === '57' ? 'selected' : ''}>57"</option>
                                <option value="65" ${saved.crankLength === '65' ? 'selected' : ''}>65"</option>
                                <option value="77" ${saved.crankLength === '77' ? 'selected' : ''}>77"</option>
                                <option value="95" ${saved.crankLength === '95' ? 'selected' : ''}>95"</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location of Crank *</label>
                            <select id="crankLocation">
                                <option value="exterior" ${!saved.crankLocation || saved.crankLocation === 'exterior' ? 'selected' : ''}>Exterior</option>
                                <option value="interior" ${saved.crankLocation === 'interior' ? 'selected' : ''}>Interior</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Conditional Fields for Motor Operation -->
                <div class="form-section ${screen.operatorType !== 'gear' ? '' : 'hidden'}" id="motorFields">
                    <h3>Motor Operation Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cord Exit *</label>
                            <select id="cordExit">
                                <option value="topRear" ${!saved.cordExit || saved.cordExit === 'topRear' ? 'selected' : ''}>Top Rear</option>
                                <option value="backTop" ${saved.cordExit === 'backTop' ? 'selected' : ''}>Back Top</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Conditional Fields for Cable Screen -->
                <div class="form-section ${screen.trackType === 'cable' ? '' : 'hidden'}" id="cableFields">
                    <h3>Cable Screen Options</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="floorMount" ${saved.floorMount ? 'checked' : ''}>
                        <label for="floorMount">Floor Mount</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="magneticLocks" ${saved.magneticLocks ? 'checked' : ''}>
                        <label for="magneticLocks">Magnetic Locks</label>
                    </div>
                </div>

                <!-- Conditional Fields for RTS Motor -->
                <div class="form-section ${screen.operatorType === 'gaposa-rts' || screen.operatorType === 'somfy-rts' ? '' : 'hidden'}" id="rtsFields">
                    <h3>RTS Motor Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Distance from Power (inches) *</label>
                            <input type="number" id="distanceFromPower" placeholder="Inches" value="${saved.distanceFromPower || screen.wiringDistance || ''}" step="1">
                        </div>
                    </div>
                </div>

                <!-- Conditional Fields for Solar Motor -->
                <div class="form-section ${screen.operatorType === 'gaposa-solar' ? '' : 'hidden'}" id="solarFields">
                    <h3>Solar Motor Details</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="extensionCord" ${saved.extensionCord ? 'checked' : ''}>
                        <label for="extensionCord">10ft Extension Cord</label>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Sunlight Exposure *</label>
                        <select id="sunlightExposure">
                            <option value="">-- Select Exposure --</option>
                            <option value="extendedDirect" ${saved.sunlightExposure === 'extendedDirect' ? 'selected' : ''}>Extended Direct</option>
                            <option value="temporaryDirect" ${saved.sunlightExposure === 'temporaryDirect' ? 'selected' : ''}>Temporary Direct</option>
                            <option value="indirect" ${saved.sunlightExposure === 'indirect' ? 'selected' : ''}>Indirect</option>
                        </select>
                    </div>
                </div>

                <!-- Installation Flags -->
                <div class="form-section">
                    <h3>Installation Flags</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="tracksRecess" ${saved.tracksRecess ? 'checked' : ''}>
                        <label for="tracksRecess">Tracks Recess-Mounted</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="lowHeadspace" ${saved.lowHeadspace ? 'checked' : ''}>
                        <label for="lowHeadspace">&lt;7.5" Headspace</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="restrictedHoriz" ${saved.restrictedHoriz ? 'checked' : ''}>
                        <label for="restrictedHoriz">Restricted Horizontal Space</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="complicatedInstall" ${saved.complicatedInstall ? 'checked' : ''}>
                        <label for="complicatedInstall">Complicated Installation</label>
                    </div>
                </div>

                <!-- Comments -->
                <div class="form-section">
                    <h3>Screen-Specific Comments</h3>
                    <textarea id="screenComments" rows="3" style="width: 100%;" placeholder="Any notes specific to this screen...">${saved.screenComments || ''}</textarea>
                </div>

                <!-- Site Photos (from quote, read-only) -->
                ${(screen.photos || []).filter(p => p.category === 'site').length > 0 ? `
                <div class="form-section">
                    <h3>Site Photos (from quote)</h3>
                    <div class="photo-grid-finalize">
                        ${(screen.photos || []).filter(p => p.category === 'site').map(p => `
                            <div class="photo-thumb">
                                <img src="${p.url || p.key}" alt="${p.filename || 'Site photo'}" onclick="window.open(this.src, '_blank')">
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Installation Photos -->
                <div class="form-section">
                    <h3>Installation Photos <span id="installPhotoCount-${index}" style="font-weight: normal; font-size: 0.85rem; color: #666;">(${(screen.photos || []).filter(p => p.category === 'installation').length}/5)</span></h3>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">Add photos highlighting installation-related concerns</p>
                    <div id="installPhotoGrid-${index}" class="photo-grid-finalize">
                        ${(screen.photos || []).filter(p => p.category === 'installation').map((p, pi) => `
                            <div class="photo-thumb">
                                <img src="${p.url || p.key}" alt="${p.filename || 'Installation photo'}" onclick="window.open(this.src, '_blank')">
                                <button class="photo-remove" onclick="removeInstallationPhoto(${index}, ${pi})" title="Remove">&times;</button>
                            </div>
                        `).join('')}
                    </div>
                    ${(screen.photos || []).filter(p => p.category === 'installation').length < 5 ? `
                    <label style="margin-top: 8px; display: inline-block;">
                        <input type="file" accept="image/*" capture="environment" multiple style="display: none;" onchange="handleInstallationPhotoSelect(event, ${index})">
                        <span style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 14px; background: #0056A3; color: white; border-radius: 4px; font-size: 0.9rem;">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                            Add Installation Photo
                        </span>
                    </label>
                    ` : ''}
                </div>

                <button class="save-button" onclick="saveCurrentScreen()">Save Measurements for Screen ${index + 1}</button>
            `;

            form.classList.add('active');

            // Add event listeners for auto-selection (whole + fraction inputs)
            updateWidthSelection();
            updateHeightSelection();

            document.getElementById('widthTop').addEventListener('input', updateWidthSelection);
            document.getElementById('widthMiddle').addEventListener('input', updateWidthSelection);
            document.getElementById('widthBottom').addEventListener('input', updateWidthSelection);
            document.getElementById('widthTopFrac').addEventListener('input', updateWidthSelection);
            document.getElementById('widthMiddleFrac').addEventListener('input', updateWidthSelection);
            document.getElementById('widthBottomFrac').addEventListener('input', updateWidthSelection);
            document.getElementById('heightLeft').addEventListener('input', updateHeightSelection);
            document.getElementById('heightMiddle').addEventListener('input', updateHeightSelection);
            document.getElementById('heightRight').addEventListener('input', updateHeightSelection);
            document.getElementById('heightLeftFrac').addEventListener('input', updateHeightSelection);
            document.getElementById('heightMiddleFrac').addEventListener('input', updateHeightSelection);
            document.getElementById('heightRightFrac').addEventListener('input', updateHeightSelection);
        }

        function updateWidthSelection() {
            const top = getMeasurement('widthTop') || Infinity;
            const middle = getMeasurement('widthMiddle') || Infinity;
            const bottom = getMeasurement('widthBottom') || Infinity;

            const min = Math.min(top, middle, bottom);

            document.getElementById('checkWidthTop').classList.toggle('selected', top === min && top !== Infinity);
            document.getElementById('checkWidthMiddle').classList.toggle('selected', middle === min && middle !== Infinity);
            document.getElementById('checkWidthBottom').classList.toggle('selected', bottom === min && bottom !== Infinity);

            // Spread warning: >2" difference among the three measurements
            const widthValues = [top, middle, bottom].filter(v => v !== Infinity);
            const spreadWarning = document.getElementById('widthSpreadWarning');
            if (widthValues.length >= 2) {
                const spread = Math.max(...widthValues) - Math.min(...widthValues);
                spreadWarning.style.display = spread > 2 ? 'block' : 'none';
            } else {
                spreadWarning.style.display = 'none';
            }

            // Quote comparison warning: selected width vs quoted width
            const quoteWarning = document.getElementById('widthQuoteWarning');
            if (min !== Infinity && quotedWidthInches > 0) {
                const diff = Math.abs(min - quotedWidthInches);
                if (diff > 2) {
                    quoteWarning.textContent = `Final width differs by more than 2" from quoted dimensions (${quotedWidthInches}"). Please verify.`;
                    quoteWarning.style.display = 'block';
                } else {
                    quoteWarning.style.display = 'none';
                }
            } else {
                quoteWarning.style.display = 'none';
            }
        }

        function updateHeightSelection() {
            const left = getMeasurement('heightLeft') || -Infinity;
            const middle = getMeasurement('heightMiddle') || -Infinity;
            const right = getMeasurement('heightRight') || -Infinity;

            const max = Math.max(left, middle, right);

            document.getElementById('checkHeightLeft').classList.toggle('selected', left === max && left !== -Infinity);
            document.getElementById('checkHeightMiddle').classList.toggle('selected', middle === max && middle !== -Infinity);
            document.getElementById('checkHeightRight').classList.toggle('selected', right === max && right !== -Infinity);

            // Auto-adjust brush size based on height slope
            const values = [left, middle, right].filter(v => v !== -Infinity);
            const brushSelect = document.getElementById('hemBarBrush');
            const slopeWarning = document.getElementById('brushSlopeWarning');
            if (values.length >= 2 && brushSelect && slopeWarning) {
                const heightMax = Math.max(...values);
                const heightMin = Math.min(...values);
                const diff = heightMax - heightMin;
                if (diff > 1) {
                    brushSelect.value = '1.5';
                    slopeWarning.style.display = 'inline';
                } else if (diff > 0.5) {
                    brushSelect.value = '1';
                    slopeWarning.style.display = 'inline';
                } else {
                    slopeWarning.style.display = 'none';
                }
            }

            // Spread warning: >2" difference among the three measurements
            const spreadWarning = document.getElementById('heightSpreadWarning');
            if (values.length >= 2) {
                const spread = Math.max(...values) - Math.min(...values);
                spreadWarning.style.display = spread > 2 ? 'block' : 'none';
            } else {
                spreadWarning.style.display = 'none';
            }

            // Quote comparison warning: selected height vs quoted height
            const quoteWarning = document.getElementById('heightQuoteWarning');
            if (max !== -Infinity && quotedHeightInches > 0) {
                const diff = Math.abs(max - quotedHeightInches);
                if (diff > 2) {
                    quoteWarning.textContent = `Final height differs by more than 2" from quoted dimensions (${quotedHeightInches}"). Please verify.`;
                    quoteWarning.style.display = 'block';
                } else {
                    quoteWarning.style.display = 'none';
                }
            } else {
                quoteWarning.style.display = 'none';
            }
        }

        function saveCurrentScreen() {
            if (currentScreenIndex === null) return;

            const screen = orderData.screens[currentScreenIndex];

            // Gather all measurements (combined whole + fraction values)
            const measurements = {
                widthTop: getMeasurement('widthTop'),
                widthMiddle: getMeasurement('widthMiddle'),
                widthBottom: getMeasurement('widthBottom'),
                heightLeft: getMeasurement('heightLeft'),
                heightMiddle: getMeasurement('heightMiddle'),
                heightRight: getMeasurement('heightRight'),
                // Store fraction strings for form restoration
                widthTopFrac: document.getElementById('widthTopFrac').value,
                widthMiddleFrac: document.getElementById('widthMiddleFrac').value,
                widthBottomFrac: document.getElementById('widthBottomFrac').value,
                heightLeftFrac: document.getElementById('heightLeftFrac').value,
                heightMiddleFrac: document.getElementById('heightMiddleFrac').value,
                heightRightFrac: document.getElementById('heightRightFrac').value,
                selectedWidth: Math.min(
                    getMeasurement('widthTop') || Infinity,
                    getMeasurement('widthMiddle') || Infinity,
                    getMeasurement('widthBottom') || Infinity
                ),
                selectedHeight: Math.max(
                    getMeasurement('heightLeft') || -Infinity,
                    getMeasurement('heightMiddle') || -Infinity,
                    getMeasurement('heightRight') || -Infinity
                ),
                operatorSide: document.getElementById('operatorSide').value,
                mountType: document.getElementById('mountType').value,
                hemBarBrush: document.getElementById('hemBarBrush').value,
                surfaceMaterial: document.getElementById('surfaceMaterial').value,
                screenComments: document.getElementById('screenComments').value,
                complete: false
            };

            // Conditional fields - Gear
            if (screen.operatorType === 'gear') {
                measurements.crankLength = document.getElementById('crankLength').value;
                measurements.crankLocation = document.getElementById('crankLocation').value;
            }

            // Conditional fields - Motor
            if (screen.operatorType !== 'gear') {
                measurements.cordExit = document.getElementById('cordExit').value;
            }

            // Conditional fields - Cable
            if (screen.trackType === 'cable') {
                measurements.floorMount = document.getElementById('floorMount').checked;
                measurements.magneticLocks = document.getElementById('magneticLocks').checked;
            }

            // Conditional fields - RTS
            if (screen.operatorType === 'gaposa-rts' || screen.operatorType === 'somfy-rts') {
                measurements.distanceFromPower = document.getElementById('distanceFromPower').value;
            }

            // Conditional fields - Solar
            if (screen.operatorType === 'gaposa-solar') {
                measurements.extensionCord = document.getElementById('extensionCord').checked;
                measurements.sunlightExposure = document.getElementById('sunlightExposure').value;
            }

            // Installation flags
            measurements.tracksRecess = document.getElementById('tracksRecess').checked;
            measurements.lowHeadspace = document.getElementById('lowHeadspace').checked;
            measurements.restrictedHoriz = document.getElementById('restrictedHoriz').checked;
            measurements.complicatedInstall = document.getElementById('complicatedInstall').checked;

            // Validate required fields
            if (!measurements.widthTop || !measurements.widthMiddle || !measurements.widthBottom ||
                !measurements.heightLeft || !measurements.heightMiddle || !measurements.heightRight ||
                !measurements.operatorSide || !measurements.surfaceMaterial) {
                alert('Please fill in all required fields.');
                return;
            }

            measurements.complete = true;

            finalMeasurements[currentScreenIndex] = measurements;
            saveMeasurements();
            displayScreenList();

            // Collapse the form and deselect current screen
            document.getElementById('measurementForm').classList.remove('active');
            currentScreenIndex = null;

            // Remove active state from all cards
            document.querySelectorAll('.screen-card').forEach(card => {
                card.classList.remove('active');
            });

            alert('Measurements saved successfully!');
        }

        function checkAllScreensComplete() {
            const allComplete = orderData.screens.every((screen, index) =>
                finalMeasurements[index] && finalMeasurements[index].complete
            );

            document.getElementById('completeButton').disabled = !allComplete;
        }

        document.getElementById('completeButton').addEventListener('click', function() {
            generateProductionEmail();
        });

        async function generateProductionEmail() {
            const productionComments = document.getElementById('productionComments').value;
            const difficultInstall = document.getElementById('difficultInstall').checked;

            // Build HTML email body
            let htmlBody = `
                <div style="font-family: 'Courier New', monospace; max-width: 800px; margin: 0 auto;">
                    <h1 style="color: #0056A3; border-bottom: 3px solid #0056A3; padding-bottom: 10px;">ROLL-A-SHIELD PRODUCTION ORDER</h1>
                    ${difficultInstall ? `
                    <div style="background: #dc3545; color: white; padding: 16px; margin: 15px 0; text-align: center; font-size: 18px; font-weight: bold; border-radius: 4px;">
                        ⚠ DIFFICULT INSTALL — Recommend installer visit for remeasure / installation prep
                    </div>
                    ` : ''}

                    <h2 style="color: #0056A3; margin-top: 30px;">CUSTOMER INFORMATION</h2>
                    <p><strong>Customer Name:</strong> ${orderData.customerName}</p>
                    ${orderData.companyName ? `<p><strong>Company:</strong> ${orderData.companyName}</p>` : ''}
                    <p><strong>Email:</strong> ${orderData.customerEmail || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${orderData.customerPhone || 'N/A'}</p>
            `;

            if (orderData.streetAddress) {
                htmlBody += `
                    <h2 style="color: #0056A3; margin-top: 30px;">PROJECT ADDRESS</h2>
                    <p>${orderData.streetAddress}</p>
                    ${orderData.aptSuite ? `<p>${orderData.aptSuite}</p>` : ''}
                    <p>${orderData.city}, ${orderData.state} ${orderData.zipCode}</p>
                    ${orderData.nearestIntersection ? `<p><strong>Nearest Intersection:</strong> ${orderData.nearestIntersection}</p>` : ''}
                `;
            }

            // Also build plain text version
            let textBody = `ROLL-A-SHIELD PRODUCTION ORDER\n`;
            textBody += `================================\n\n`;

            if (difficultInstall) {
                textBody += `⚠⚠⚠ DIFFICULT INSTALL — Recommend installer visit for remeasure / installation prep ⚠⚠⚠\n\n`;
            }

            textBody += `CUSTOMER INFORMATION:\n`;
            textBody += `Customer Name: ${orderData.customerName}\n`;
            if (orderData.companyName) textBody += `Company: ${orderData.companyName}\n`;
            textBody += `Email: ${orderData.customerEmail || 'N/A'}\n`;
            textBody += `Phone: ${orderData.customerPhone || 'N/A'}\n`;

            if (orderData.streetAddress) {
                textBody += `\nPROJECT ADDRESS:\n`;
                textBody += `${orderData.streetAddress}\n`;
                if (orderData.aptSuite) textBody += `${orderData.aptSuite}\n`;
                textBody += `${orderData.city}, ${orderData.state} ${orderData.zipCode}\n`;
                if (orderData.nearestIntersection) textBody += `Nearest Intersection: ${orderData.nearestIntersection}\n`;
            }

            textBody += `\n\n`;

            orderData.screens.forEach((screen, index) => {
                const meas = finalMeasurements[index];

                // HTML version
                htmlBody += `
                    <div style="border: 2px solid #0056A3; padding: 20px; margin: 20px 0; background: #f9f9f9;">
                        <h2 style="color: #0056A3; margin-top: 0;">SCREEN ${index + 1}</h2>

                        <h3 style="color: #333;">SCREEN SPECIFICATIONS</h3>
                        <p><strong>Track System:</strong> ${screen.trackTypeName}</p>
                        <p><strong>Operator:</strong> ${screen.operatorTypeName}</p>
                        <p><strong>Fabric Color:</strong> ${screen.fabricColorName}</p>
                        <p><strong>Frame Color:</strong> ${screen.frameColorName}</p>

                        <h3 style="color: #333; margin-top: 20px;">FINAL MEASUREMENTS (Opening Only)</h3>
                        <p><strong>Width (Top):</strong> ${meas.widthTop}"</p>
                        <p><strong>Width (Middle):</strong> ${meas.widthMiddle}"</p>
                        <p><strong>Width (Bottom):</strong> ${meas.widthBottom}"</p>
                        <p style="background: #28a745; color: white; padding: 10px; font-weight: bold;">>>> OPENING WIDTH: ${meas.selectedWidth}"</p>

                        <p style="margin-top: 15px;"><strong>Height (Left):</strong> ${meas.heightLeft}"</p>
                        <p><strong>Height (Middle):</strong> ${meas.heightMiddle}"</p>
                        <p><strong>Height (Right):</strong> ${meas.heightRight}"</p>
                        <p style="background: #28a745; color: white; padding: 10px; font-weight: bold;">>>> OPENING HEIGHT: ${meas.selectedHeight}"</p>
                ${screen.trackType && screen.trackType.startsWith('sunair') ? `
                        <h3 style="color: #0056A3; margin-top: 20px;">SUNAIR ORDERING MEASUREMENTS</h3>
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Opening measurements + headbox/tracks for Sunair ordering</p>
                        <p style="background: #0056A3; color: white; padding: 10px; font-weight: bold;">
                            >>> ORDERING WIDTH: ${screen.noTracks ? meas.selectedWidth : (parseFloat(meas.selectedWidth) + 5).toFixed(2)}"
                            ${screen.noTracks ? '(no tracks)' : '(+5" for tracks)'}
                        </p>
                        <p style="background: #0056A3; color: white; padding: 10px; font-weight: bold; margin-top: 4px;">
                            >>> ORDERING HEIGHT: ${meas.mountType === 'ceiling'
                                ? (parseFloat(meas.selectedHeight) + 5.25).toFixed(2) + '" (+5.25" ceiling mount incl. box)'
                                : (parseFloat(meas.selectedHeight) + 7.25).toFixed(2) + '" (+7.25" wall mount incl. box + hem bar)'}
                        </p>
                ` : ''}
                ${screen.trackType === 'fenetex-keder' ? `
                        <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 12px; margin-top: 15px;">
                            <p style="color: #856404; font-weight: bold; margin: 0;">⚠ FENETEX SCREEN — Opening measurements only.</p>
                            <p style="color: #856404; margin: 4px 0 0 0;">Production must add track and headbox measurements before ordering.</p>
                        </div>
                ` : ''}

                        <h3 style="color: #333; margin-top: 20px;">INSTALLATION DETAILS</h3>
                        <p><strong>Operator Side:</strong> ${meas.operatorSide.toUpperCase()}</p>
                        <p><strong>Mount Type:</strong> ${meas.mountType}</p>
                        <p><strong>Hem Bar Brush:</strong> ${meas.hemBarBrush}</p>
                        <p><strong>Surface Material:</strong> ${meas.surfaceMaterial}</p>
                `;

                // Text version
                textBody += `\n========================================\n`;
                textBody += `SCREEN ${index + 1}\n`;
                textBody += `========================================\n\n`;

                textBody += `SCREEN SPECIFICATIONS:\n`;
                textBody += `Track System: ${screen.trackTypeName}\n`;
                textBody += `Operator: ${screen.operatorTypeName}\n`;
                textBody += `Fabric Color: ${screen.fabricColorName}\n`;
                textBody += `Frame Color: ${screen.frameColorName}\n\n`;

                textBody += `FINAL MEASUREMENTS (Opening Only):\n`;
                textBody += `Width (Top): ${meas.widthTop}"\n`;
                textBody += `Width (Middle): ${meas.widthMiddle}"\n`;
                textBody += `Width (Bottom): ${meas.widthBottom}"\n`;
                textBody += `>>> OPENING WIDTH: ${meas.selectedWidth}"\n\n`;

                textBody += `Height (Left): ${meas.heightLeft}"\n`;
                textBody += `Height (Middle): ${meas.heightMiddle}"\n`;
                textBody += `Height (Right): ${meas.heightRight}"\n`;
                textBody += `>>> OPENING HEIGHT: ${meas.selectedHeight}"\n\n`;

                if (screen.trackType && screen.trackType.startsWith('sunair')) {
                    const orderWidth = screen.noTracks ? parseFloat(meas.selectedWidth) : parseFloat(meas.selectedWidth) + 5;
                    const orderHeight = meas.mountType === 'ceiling'
                        ? parseFloat(meas.selectedHeight) + 5.25
                        : parseFloat(meas.selectedHeight) + 7.25;
                    textBody += `SUNAIR ORDERING MEASUREMENTS:\n`;
                    textBody += `>>> ORDERING WIDTH: ${orderWidth.toFixed(2)}" ${screen.noTracks ? '(no tracks)' : '(+5" for tracks)'}\n`;
                    textBody += `>>> ORDERING HEIGHT: ${orderHeight.toFixed(2)}" ${meas.mountType === 'ceiling' ? '(+5.25" ceiling mount incl. box)' : '(+7.25" wall mount incl. box + hem bar)'}\n\n`;
                }

                if (screen.trackType === 'fenetex-keder') {
                    textBody += `⚠ FENETEX SCREEN — Opening measurements only.\n`;
                    textBody += `Production must add track and headbox measurements before ordering.\n\n`;
                }

                textBody += `INSTALLATION DETAILS:\n`;
                textBody += `Operator Side: ${meas.operatorSide.toUpperCase()}\n`;
                textBody += `Mount Type: ${meas.mountType}\n`;
                textBody += `Hem Bar Brush: ${meas.hemBarBrush}\n`;
                textBody += `Surface Material: ${meas.surfaceMaterial}\n\n`;

                if (screen.operatorType === 'gear') {
                    htmlBody += `
                        <h3 style="color: #333; margin-top: 20px;">GEAR OPERATION</h3>
                        <p><strong>Crank Length:</strong> ${meas.crankLength}"</p>
                        <p><strong>Crank Location:</strong> ${meas.crankLocation}</p>
                    `;
                    textBody += `GEAR OPERATION:\n`;
                    textBody += `Crank Length: ${meas.crankLength}"\n`;
                    textBody += `Crank Location: ${meas.crankLocation}\n\n`;
                }

                if (screen.operatorType !== 'gear') {
                    htmlBody += `
                        <h3 style="color: #333; margin-top: 20px;">MOTOR OPERATION</h3>
                        <p><strong>Cord Exit:</strong> ${meas.cordExit}</p>
                    `;
                    textBody += `MOTOR OPERATION:\n`;
                    textBody += `Cord Exit: ${meas.cordExit}\n\n`;
                }

                if (screen.trackType === 'cable') {
                    htmlBody += `
                        <h3 style="color: #333; margin-top: 20px;">CABLE SCREEN OPTIONS</h3>
                        <p><strong>Floor Mount:</strong> ${meas.floorMount ? 'YES' : 'NO'}</p>
                        <p><strong>Magnetic Locks:</strong> ${meas.magneticLocks ? 'YES' : 'NO'}</p>
                    `;
                    textBody += `CABLE SCREEN OPTIONS:\n`;
                    textBody += `Floor Mount: ${meas.floorMount ? 'YES' : 'NO'}\n`;
                    textBody += `Magnetic Locks: ${meas.magneticLocks ? 'YES' : 'NO'}\n\n`;
                }

                if (screen.operatorType === 'gaposa-rts' || screen.operatorType === 'somfy-rts') {
                    htmlBody += `
                        <h3 style="color: #333; margin-top: 20px;">RTS MOTOR</h3>
                        <p><strong>Distance from Power:</strong> ${meas.distanceFromPower}"</p>
                    `;
                    textBody += `RTS MOTOR:\n`;
                    textBody += `Distance from Power: ${meas.distanceFromPower}"\n\n`;
                }

                if (screen.operatorType === 'gaposa-solar') {
                    htmlBody += `
                        <h3 style="color: #333; margin-top: 20px;">SOLAR MOTOR</h3>
                        <p><strong>10ft Extension Cord:</strong> ${meas.extensionCord ? 'YES' : 'NO'}</p>
                        <p><strong>Sunlight Exposure:</strong> ${meas.sunlightExposure}</p>
                    `;
                    textBody += `SOLAR MOTOR:\n`;
                    textBody += `10ft Extension Cord: ${meas.extensionCord ? 'YES' : 'NO'}\n`;
                    textBody += `Sunlight Exposure: ${meas.sunlightExposure}\n\n`;
                }

                const flags = [];
                if (meas.tracksRecess) flags.push('Tracks Recess-Mounted');
                if (meas.lowHeadspace) flags.push('<6" Headspace');
                if (meas.restrictedHoriz) flags.push('Restricted Horizontal Space');
                if (meas.complicatedInstall) flags.push('Complicated Installation');

                if (flags.length > 0) {
                    htmlBody += `
                        <h3 style="color: #dc3545; margin-top: 20px;">⚠ INSTALLATION FLAGS</h3>
                        <ul style="color: #dc3545;">
                    `;
                    flags.forEach(flag => {
                        htmlBody += `<li>${flag}</li>`;
                        textBody += `⚠ ${flag}\n`;
                    });
                    htmlBody += `</ul>`;
                    textBody += `\n`;
                }

                if (meas.screenComments) {
                    htmlBody += `
                        <h3 style="color: #333; margin-top: 20px;">SCREEN NOTES</h3>
                        <p style="background: #fff3cd; padding: 10px; border-left: 4px solid #ffc107;">${meas.screenComments}</p>
                    `;
                    textBody += `SCREEN NOTES:\n${meas.screenComments}\n\n`;
                }

                // Photo links
                const screenPhotos = screen.photos || [];
                const sitePhotos = screenPhotos.filter(p => p.category === 'site');
                const installPhotos = screenPhotos.filter(p => p.category === 'installation');
                if (sitePhotos.length > 0 || installPhotos.length > 0) {
                    htmlBody += `<h3 style="color: #333; margin-top: 20px;">PHOTOS</h3>`;
                    textBody += `PHOTOS:\n`;
                    if (sitePhotos.length > 0) {
                        htmlBody += `<p><strong>Site Photos (${sitePhotos.length}):</strong></p><ul>`;
                        textBody += `Site Photos (${sitePhotos.length}):\n`;
                        sitePhotos.forEach(p => {
                            htmlBody += `<li><a href="${p.url}" target="_blank">${p.filename || 'Photo'}</a></li>`;
                            textBody += `  - ${p.url}\n`;
                        });
                        htmlBody += `</ul>`;
                    }
                    if (installPhotos.length > 0) {
                        htmlBody += `<p><strong>Installation Photos (${installPhotos.length}):</strong></p><ul>`;
                        textBody += `Installation Photos (${installPhotos.length}):\n`;
                        installPhotos.forEach(p => {
                            htmlBody += `<li><a href="${p.url}" target="_blank">${p.filename || 'Photo'}</a></li>`;
                            textBody += `  - ${p.url}\n`;
                        });
                        htmlBody += `</ul>`;
                    }
                    textBody += `\n`;
                }

                htmlBody += `</div>`;
            });

            // Project-level accessories
            const projAcc = orderData.projectAccessories || [];
            if (projAcc.length > 0) {
                htmlBody += `
                    <div style="border: 2px solid #6f42c1; padding: 20px; margin: 20px 0; background: #f5f0ff;">
                        <h2 style="color: #6f42c1; margin-top: 0;">PROJECT ACCESSORIES</h2>
                        <ul>
                `;
                textBody += `\n========================================\n`;
                textBody += `PROJECT ACCESSORIES:\n`;
                projAcc.forEach(acc => {
                    htmlBody += `<li>${acc.name}${acc.quantity > 1 ? ' (x' + acc.quantity + ')' : ''}</li>`;
                    textBody += `  - ${acc.name}${acc.quantity > 1 ? ' (x' + acc.quantity + ')' : ''}\n`;
                });
                htmlBody += `</ul></div>`;
                textBody += `\n`;
            }

            if (productionComments) {
                htmlBody += `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; margin: 20px 0;">
                        <h2 style="color: #856404; margin-top: 0;">GENERAL PRODUCTION COMMENTS</h2>
                        <p>${productionComments}</p>
                    </div>
                `;
                textBody += `\n========================================\n`;
                textBody += `GENERAL PRODUCTION COMMENTS:\n`;
                textBody += `${productionComments}\n`;
            }

            htmlBody += `</div>`;

            // Send email via Cloudflare Worker
            const subject = difficultInstall
                ? `⚠ DIFFICULT INSTALL - Production Order - ${orderData.customerName}`
                : `Production Order - ${orderData.customerName}`;
            const completeButton = document.getElementById('completeButton');
            
            if (completeButton) {
                completeButton.disabled = true;
                completeButton.textContent = 'Sending Email...';
            }

            try {
                const response = await fetch(`${WORKER_URL}/api/send-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        from: 'Roll-A-Shield Production <noreply@updates.rollashield.com>',
                        to: ['derek@rollashield.com'],
                        subject: subject,
                        html: htmlBody,
                        text: textBody
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(`✅ Production order email sent successfully to derek@rollashield.com!\n\nEmail ID: ${result.emailId}`);
                } else {
                    console.error('Email API error:', result);
                    alert('❌ Failed to send email: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert('❌ Failed to send email. Please check your internet connection and try again.\n\nError: ' + error.message);
            } finally {
                if (completeButton) {
                    completeButton.disabled = false;
                    completeButton.textContent = 'Generate Production Email';
                }
            }
        }
    </script>
</body>
</html>
